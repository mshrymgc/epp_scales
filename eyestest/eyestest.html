<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>EYES TEST - å¿ƒã®èª­ã¿å–ã‚Šæ¤œæŸ»</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #f5f5f7 0%, #ffffff 100%);
    }
    .jspsych-content {
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    h1 {
      color: #1d1d1f;
      font-size: 1.8rem;
      margin: 0 0 1rem 0;
      font-weight: 700;
      text-align: center;
    }
    h2 {
      color: #0071e3;
      font-size: 1.3rem;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
      font-weight: 600;
    }
    .jspsych-btn {
      background-color: #0071e3;
      color: #fff;
      border: 1px solid #0071e3;
      padding: 0.6rem 1.2rem;
      margin: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    .jspsych-btn:hover {
      background-color: #0059b3;
      border-color: #0059b3;
    }
    .status-bar {
      display: flex;
      justify-content: space-around;
      margin: 1rem 0;
      padding: 1rem;
      background: #f5f5f7;
      border-radius: 8px;
    }
    .status-item {
      text-align: center;
    }
    .status-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.3rem;
    }
    .status-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1d1d1f;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .result-item {
      background: #f5f5f7;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .result-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .result-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1d1d1f;
    }
    .result-value.positive {
      color: #34c759;
    }
    .result-value.negative {
      color: #ff3b30;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.5.0/dist/index.browser.min.js"></script>
  <script>
(() => {
  function detectSystemInfo() {
    const ua = navigator.userAgent;
    let browser = 'Unknown', os = 'Unknown';
    if (ua.indexOf('Firefox') > -1) browser = 'Firefox';
    else if (ua.indexOf('Opera') > -1 || ua.indexOf('OPR') > -1) browser = 'Opera';
    else if (ua.indexOf('Trident') > -1) browser = 'Internet Explorer';
    else if (ua.indexOf('Edge') > -1 || ua.indexOf('Edg') > -1) browser = 'Edge';
    else if (ua.indexOf('Chrome') > -1) browser = 'Chrome';
    else if (ua.indexOf('Safari') > -1) browser = 'Safari';
    if (ua.indexOf('Win') > -1) os = 'Windows';
    else if (ua.indexOf('Mac') > -1) os = 'macOS';
    else if (ua.indexOf('Linux') > -1) os = 'Linux';
    else if (ua.indexOf('Android') > -1) os = 'Android';
    else if (ua.indexOf('iOS') > -1 || ua.indexOf('iPhone') > -1 || ua.indexOf('iPad') > -1) os = 'iOS';
    return { browser, os, userAgent: ua };
  }

  const jsPsych = window.jsPsychModule.initJsPsych({
    display_element: 'jspsych-target'
  });

  const subjectId = jsPsych.randomization.randomID(10);
  const systemInfo = detectSystemInfo();
  jsPsych.data.addProperties({
    subject_id: subjectId,
    timestamp_start: new Date().toISOString(),
    browser: systemInfo.browser,
    os: systemInfo.os,
    task_name: 'EYES_TEST',
    total_trials: 36
  });

  function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }

  const eyeTrials = [
    { image: "eyes_pngs/eyes_01.png", correct: 1, options: ["ãŠã©ã‘ã¦ã„ã‚‹", "æ…°ã‚ã‚ˆã†ã¨ã—ã¦ã„ã‚‹", "ã„ã‚‰ã ã£ã¦ã„ã‚‹", "ã†ã‚“ã–ã‚Šã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_02.png", correct: 2, options: ["ãŠã³ãˆã¦ã„ã‚‹", "ç‹¼ç‹½ã—ã¦ã„ã‚‹", "æ¨ªæŸ„ãªæ°—åˆ†ã§ã‚ã‚‹", "ä¸æ„‰å¿«ã«æ€ã£ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_03.png", correct: 0, options: ["ãµã–ã‘ã¦ã„ã‚‹", "ã†ã‚ãŸãˆã¦ã„ã‚‹", "æ¬²æœ›ã‚’æŠ±ã„ã¦ã„ã‚‹", "ä½•ã‹ã‚’ç¢ºè¨€ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_04.png", correct: 1, options: ["ãµã–ã‘ã¦ã„ã‚‹", "ä½•ã‹ã‚’å¼·ãè¨´ãˆã¦ã„ã‚‹", "é¢ç™½ãŒã£ã¦ã„ã‚‹", "ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_05.png", correct: 2, options: ["ã„ã‚‰ã ã£ã¦ã„ã‚‹", "çš®è‚‰ãªæ°—åˆ†ã§ã‚ã‚‹", "å¿ƒé…ã—ã¦ã„ã‚‹", "è¦ªã—ã’ãªæ°—æŒã¡ã‚’æŠ±ã„ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_06.png", correct: 0, options: ["ãã‚‡ã£ã¨ã—ã¦ã„ã‚‹", "ç©ºæƒ³ã«ãµã‘ã£ã¦ã„ã‚‹", "ã˜ã‚Šã˜ã‚Šã—ã¦ã„ã‚‹", "è­¦æˆ’ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_07.png", correct: 3, options: ["ã™ã¾ãªãŒã£ã¦ã„ã‚‹", "è¦ªã—ã’ãªæ°—æŒã¡ã‚’æŠ±ã„ã¦ã„ã‚‹", "è½ã¡ç€ã‹ãªã„æ°—æŒã¡ã§ã„ã‚‹", "å…ƒæ°—ã‚’ãªãã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_08.png", correct: 1, options: ["æ°—è½ã¡ã—ã¦ã„ã‚‹", "ã»ã£ã¨ã—ã¦ã„ã‚‹", "æ¥ãšã‹ã—ãŒã£ã¦ã„ã‚‹", "èˆˆå¥®ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_09.png", correct: 3, options: ["ä¸æ„‰å¿«ã«æ€ã£ã¦ã„ã‚‹", "æ•µæ„ã‚’æŠ±ã„ã¦ã„ã‚‹", "æ€–ãŒã£ã¦ã„ã‚‹", "ã»ã‹ã®ã“ã¨ã«æ°—ã‚’å–ã‚‰ã‚Œã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_10.png", correct: 0, options: ["ç”¨å¿ƒã—ã¦ã„ã‚‹", "ä½•ã‹ã‚’å¼·ãè¨´ãˆã¦ã„ã‚‹", "ã†ã‚“ã–ã‚Šã—ã¦ã„ã‚‹", "ãã‚‡ã£ã¨ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_11.png", correct: 2, options: ["ãŠã³ãˆã¦ã„ã‚‹", "é¢ç™½ãŒã£ã¦ã„ã‚‹", "æ‚”ã‚„ã‚“ã§ã„ã‚‹", "æ°—ã®ã‚ã‚‹ãã¶ã‚Šã‚’ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_12.png", correct: 3, options: ["ç„¡é–¢å¿ƒã§ã‚ã‚‹", "ãã¾ã‚ŠãŒæ‚ªã„", "ç–‘ã„ã‚’æŠ±ã„ã¦ã„ã‚‹", "å…ƒæ°—ã‚’ãªãã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_13.png", correct: 0, options: ["æ±ºæ„ã‚’å›ºã‚ã¦ã„ã‚‹", "ä½•ã‹ã‚’æœŸå¾…ã—ã¦ã„ã‚‹", "è„…ã—ã¦ã„ã‚‹", "æ¥ãšã‹ã—ãŒã£ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_14.png", correct: 2, options: ["ã„ã‚‰ã ã£ã¦ã„ã‚‹", "ãŒã£ã‹ã‚Šã—ã¦ã„ã‚‹", "è½ã¡è¾¼ã‚“ã§ã„ã‚‹", "éé›£ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_15.png", correct: 0, options: ["é»™æƒ³ã—ã¦ã„ã‚‹", "ã†ã‚ãŸãˆã¦ã„ã‚‹", "åŠ±ã¾ãã†ã¨ã—ã¦ã„ã‚‹", "é¢ç™½ãŒã£ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_16.png", correct: 3, options: ["ã„ã‚‰ã ã£ã¦ã„ã‚‹", "è€ƒãˆã«ãµã‘ã£ã¦ã„ã‚‹", "åŠ±ã¾ãã†ã¨ã—ã¦ã„ã‚‹", "åŒæƒ…ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_17.png", correct: 1, options: ["ç–‘ã£ã¦ã„ã‚‹", "æ„›æƒ…ã‚’æŒã£ã¦ã„ã‚‹", "ãŠã©ã‘ã¦ã„ã‚‹", "ãã‚‡ã£ã¨ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_18.png", correct: 0, options: ["æ±ºæ„ã‚’å›ºã‚ã¦ã„ã‚‹", "é¢ç™½ãŒã£ã¦ã„ã‚‹", "ãã‚‡ã£ã¨ã—ã¦ã„ã‚‹", "ã†ã‚“ã–ã‚Šã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_19.png", correct: 1, options: ["æ¨ªæŸ„ãªæ°—åˆ†ã§ã‚ã‚‹", "æ„Ÿè¬ã—ã¦ã„ã‚‹", "çš®è‚‰ã‚’è¨€ã£ã¦ã„ã‚‹", "ãŸã‚ã‚‰ã£ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_20.png", correct: 0, options: ["è‡ªåˆ†ãŒå„ªä½ã«ç«‹ã¨ã†ã¨ã—ã¦ã„ã‚‹", "è¦ªã—ã’ãªæ°—æŒã¡ã‚’æŠ±ã„ã¦ã„ã‚‹", "æ°—ãŒã¨ãŒã‚ã¦ã„ã‚‹", "æ€–ãŒã£ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_21.png", correct: 2, options: ["ãã¾ã‚ŠãŒæ‚ªã„", "ç©ºæƒ³ã«ãµã‘ã£ã¦ã„ã‚‹", "å›°æƒ‘ã—ã¦ã„ã‚‹", "æ··ä¹±ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_22.png", correct: 3, options: ["ã»ã‹ã®ã“ã¨ã«æ°—ã‚’å–ã‚‰ã‚Œã¦ã„ã‚‹", "æ„Ÿè¬ã—ã¦ã„ã‚‹", "ä½•ã‹ã‚’å¼·ãè¨´ãˆã¦ã„ã‚‹", "å“€é¡˜ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_23.png", correct: 0, options: ["æº€è¶³ã—ã¦ã„ã‚‹", "ç”³ã—è¨³ãªã„ã¨æ€ã£ã¦ã„ã‚‹", "é–‹ãç›´ã£ã¦ã„ã‚‹", "å¥½å¥‡å¿ƒã‚’æŠ±ã„ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_24.png", correct: 0, options: ["ç‰©æ€ã„ã«ãµã‘ã£ã¦ã„ã‚‹", "ã„ã‚‰ã ã£ã¦ã„ã‚‹", "èˆˆå¥®ã—ã¦ã„ã‚‹", "æ•µæ„ã‚’æŠ±ã„ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_25.png", correct: 3, options: ["æ··ä¹±ã—ã¦ã„ã‚‹", "ä¿¡ã˜ã‚‰ã‚Œãªã„ã¨æ€ã£ã¦ã„ã‚‹", "æ°—è½ã¡ã—ã¦ã„ã‚‹", "èˆˆå‘³ã‚’æŒã£ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_26.png", correct: 1, options: ["æˆ’ã—ã¦ã„ã‚‹", "æ¥ãšã‹ã—ãŒã£ã¦ã„ã‚‹", "æ•µæ„ã‚’æŠ±ã„ã¦ã„ã‚‹", "ä¸å®‰ã«æ€ã£ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_27.png", correct: 0, options: ["ãµã–ã‘ã¦ã„ã‚‹", "ç”¨å¿ƒã—ã¦ã„ã‚‹", "æ¨ªæŸ„ãªæ°—åˆ†ã§ã‚ã‚‹", "å®‰å¿ƒã•ã›ã‚ˆã†ã¨ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_28.png", correct: 2, options: ["èˆˆå‘³ã‚’æŒã£ã¦ã„ã‚‹", "ãµã–ã‘ã¦ã„ã‚‹", "æ„›æƒ…ã‚’æŒã£ã¦ã„ã‚‹", "æº€è¶³ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_29.png", correct: 3, options: ["ã˜ã‚Šã˜ã‚Šã—ã¦ã„ã‚‹", "ãã‚‡ã£ã¨ã—ã¦ã„ã‚‹", "ã„ã‚‰ã ã£ã¦ã„ã‚‹", "å†…é¢ã‚’è¦‹ã¤ã‚ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_30.png", correct: 0, options: ["æ„Ÿè¬ã—ã¦ã„ã‚‹", "æ°—ã®ã‚ã‚‹ãã¶ã‚Šã‚’ã—ã¦ã„ã‚‹", "æ•µæ„ã‚’æŠ±ã„ã¦ã„ã‚‹", "ãŒã£ã‹ã‚Šã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_31.png", correct: 0, options: ["æ¥ã˜ã¦ã„ã‚‹", "è‡ªä¿¡ã«æº€ã¡ã¦ã„ã‚‹", "ãµã–ã‘ã¦ã„ã‚‹", "å…ƒæ°—ã‚’ãªãã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_32.png", correct: 1, options: ["çœŸå‰£ã«ãªã£ã¦ã„ã‚‹", "æ¥ã˜ã¦ã„ã‚‹", "å½“æƒ‘ã—ã¦ã„ã‚‹", "è­¦æˆ’ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_33.png", correct: 2, options: ["ãã¾ã‚ŠãŒæ‚ªã„", "æ°—ãŒã¨ãŒã‚ã¦ã„ã‚‹", "ç©ºæƒ³ã«ãµã‘ã£ã¦ã„ã‚‹", "å¿ƒé…ãã†ã«ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_34.png", correct: 1, options: ["ãã‚‡ã£ã¨ã—ã¦ã„ã‚‹", "ã¨ã¾ã©ã£ã¦ã„ã‚‹", "é ¼ã§ããªã„ã¨æ€ã£ã¦ã„ã‚‹", "ãŠã³ãˆã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_35.png", correct: 3, options: ["å›°ã£ã¦ã„ã‚‹", "ç¥çµŒè³ªã«ãªã£ã¦ã„ã‚‹", "ä½•ã‹ã‚’å¼·ãè¨´ãˆã¦ã„ã‚‹", "ç†Ÿæ…®ã—ã¦ã„ã‚‹"] },
    { image: "eyes_pngs/eyes_36.png", correct: 2, options: ["æ¥ã˜ã¦ã„ã‚‹", "ç¥çµŒè³ªã«ãªã£ã¦ã„ã‚‹", "ç–‘ã£ã¦ã„ã‚‹", "æ±ºå¿ƒãŒã¤ã‹ãªã„ã§ã„ã‚‹"] },
  ];

  const timeline = [];
  const shuffledTrials = shuffleArray(eyeTrials);
  let responses = [];

  timeline.push({
    type: window.jsPsychHtmlButtonResponse,
    stimulus: '<div class="card"><h1>ğŸ‘ï¸ EYES TEST</h1><h2>å¿ƒã®èª­ã¿å–ã‚Šæ¤œæŸ»</h2><p style="text-align: center; color: #666; margin: 1rem 0;">ã“ã®èª²é¡Œã§ã¯ã€äººç‰©ã®ç›®ã®é ˜åŸŸã®ç”»åƒã‚’è¦‹ã¦ã€ãã®äººãŒä½•ã‚’è€ƒãˆãŸã‚Šã€æ„Ÿã˜ãŸã‚Šã—ã¦ã„ã‚‹ã‹ã‚’æ¨æ¸¬ã—ã¾ã™ã€‚<br>å…¨36å•ã®è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚å„å•é¡Œã«ã¤ã„ã¦ã€æœ€ã‚‚é©åˆ‡ã¨æ€ã‚ã‚Œã‚‹å¿ƒç†çŠ¶æ…‹ã‚„æ„Ÿæƒ…ã‚’4ã¤ã®é¸æŠè‚¢ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚</p></div>',
    choices: ['é–‹å§‹ã™ã‚‹']
  });

  // å¹´é½¢ãƒ»æ€§åˆ¥å…¥åŠ›
  timeline.push({
    type: window.jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="card" style="max-width: 600px;">
        <h2 style="text-align: center;">å‚åŠ è€…æƒ…å ±ã®å…¥åŠ›</h2>
        <div style="margin: 2rem 0;">
          <div style="margin: 1rem 0;">
            <label for="age_input" style="display: block; margin-bottom: 0.5rem;">å¹´é½¢: <span style="color: red;">*</span></label>
            <input type="number" id="age_input" min="1" max="150" style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px;" />
          </div>
          <div style="margin: 1rem 0;">
            <label for="gender_input" style="display: block; margin-bottom: 0.5rem;">æ€§åˆ¥: <span style="color: red;">*</span></label>
            <select id="gender_input" style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">-- é¸æŠ --</option>
              <option value="ç”·æ€§">ç”·æ€§</option>
              <option value="å¥³æ€§">å¥³æ€§</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
              <option value="æœªå›ç­”">æœªå›ç­”</option>
            </select>
          </div>
          <div id="error_message" style="color: red; margin-top: 1rem; text-align: center; display: none; font-weight: bold;">
            å¹´é½¢ã¨æ€§åˆ¥ã¯å¿…é ˆã§ã™ã€‚
          </div>
        </div>
      </div>
    `,
    choices: ['æ¬¡ã¸é€²ã‚€'],
    on_load: () => {
      const button = document.querySelector('.jspsych-btn');
      button.addEventListener('click', (e) => {
        const age = document.getElementById('age_input')?.value;
        const gender = document.getElementById('gender_input')?.value;
        
        if (!age || !gender || age === '' || gender === '') {
          e.preventDefault();
          e.stopPropagation();
          document.getElementById('error_message').style.display = 'block';
          return false;
        }
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéå¾Œã€ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«è¨˜éŒ²
        jsPsych.data.addProperties({
          age: age,
          gender: gender
        });
      });
    },
    on_finish: (data) => {
      const age = document.getElementById('age_input')?.value || '';
      const gender = document.getElementById('gender_input')?.value || '';
      data.age = age;
      data.gender = gender;
    }
  });

  shuffledTrials.forEach((trial, index) => {
    timeline.push({
      type: window.jsPsychHtmlButtonResponse,
      stimulus: `<div class="card"><h2>å•é¡Œ ${index + 1} / 36</h2><p style="text-align: center; color: #666;">ã“ã®äººç‰©ã¯ä½•ã‚’è€ƒãˆãŸã‚Šã€æ„Ÿã˜ãŸã‚Šã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</p><div style="text-align: center;"><img src="${trial.image}" style="max-width: 400px; height: auto; border-radius: 8px;" alt="eyes" /></div><div class="status-bar"><div class="status-item"><div class="status-label">é€²æ—</div><div class="status-value">${index + 1}/36</div></div></div></div>`,
      choices: trial.options,
      button_html: '<button class="jspsych-btn">%choice%</button>',
      on_finish: (data) => {
        const isCorrect = data.response === trial.correct;
        responses.push({ trial: index + 1, is_correct: isCorrect, chosen: data.response });
      }
    });
  });

  // =====================================
  // ãƒ‡ãƒ¼ã‚¿ä¿å­˜è©¦è¡Œï¼ˆDatapipeçµŒç”±ï¼‰- æœ€çµ‚çµæœè¡¨ç¤ºã®å‰ã«å®Ÿè¡Œ
  // =====================================
  timeline.push({
    type: window.jsPsychPipe,
    action: 'save',
    experiment_id: 'nSkF9Rz1SbMV',
    filename: () => {
      try {
        const allData = jsPsych.data.get().values();
        const subjectId = allData.length > 0 ? allData[0].subject_id : 'unknown_subject';
        console.log('=== Pipe trial: filename:', subjectId);
        return `${subjectId}.csv`;
      } catch (e) {
        console.error('Filename error:', e);
        return 'unknown_subject.csv';
      }
    },
    data_string: () => {
      try {
        const csvData = jsPsych.data.get().csv();
        console.log('=== Pipe trial: CSV size:', csvData.length, 'bytes');
        return csvData;
      } catch (e) {
        console.error('CSV error:', e);
        return '';
      }
    },
    on_finish: () => {
      console.log('=== Pipe trial on_finish: Data saved successfully ===');
      // å¯èƒ½ã§ã‚ã‚Œã°ç›´å‰ã®ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ‹¾ã£ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿æŒï¼ˆæœªå®šç¾©ã§ã‚‚å•é¡Œãªã—ï¼‰
      try {
        const last = jsPsych.data.get().last(1).values()[0] || {};
        window.pipeStatus = {
          success: last.success ?? null,
          message: last.message ?? '',
        };
        console.log('=== Pipe status ===', window.pipeStatus);
      } catch (e) {
        console.warn('Pipe status capture failed:', e);
      } 
    }
  });

  timeline.push({
    type: window.jsPsychHtmlButtonResponse,
    stimulus: function() {
      const correctCount = responses.filter((r) => r.is_correct).length;
      const percentage = Math.round((correctCount / 36) * 100);
      return `<div class="card"><h1>ãƒ†ã‚¹ãƒˆå®Œäº†</h1><div class="result-grid"><div class="result-item"><div class="result-label">æ­£ç­”æ•°</div><div class="result-value" style="color: #34c759; font-size: 2rem;">${correctCount} / 36</div></div><div class="result-item"><div class="result-label">æ­£ç­”ç‡</div><div class="result-value" style="font-size: 2rem;">${percentage}%</div></div></div></div>`;
    },
    choices: ['çµ‚äº†'],
    on_finish: (data) => {
      // çµæœç¢ºèªå¾Œã«ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸é·ç§»
      setTimeout(() => {
        window.location.href = 'https://mshrymgc.github.io/epp_scales/';
      }, 500);
    }
  });

  jsPsych.run(timeline);
})();
  </script>
</body>
</html>
