<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SD3-J</title>
  <link rel="stylesheet" href="./dist/jspsych.css" />
  <link rel="stylesheet" href="./dist/survey.min.css" />
  <style>
    body { font-family: system-ui, sans-serif; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:1rem; }
    .grid { display:grid; gap:1rem; }
    .chart-wrap { position:relative; width:100%; max-width:500px; height:46vh; max-height:420px; margin:0 auto; }
    .chart-wrap canvas { display:block; margin:0 auto; }
    table { border-collapse:collapse; width:100%; }
    th, td { padding:0.4rem 0.3rem; border-bottom:1px solid #eee; text-align:left; }
    .small { font-size: 0.85rem; }
    .muted { color:#666 }
    .likert-label-tooltip { position: relative; }
    .likert-label-tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 0.4rem 0.6rem; border-radius: 4px; white-space: nowrap; font-size: 0.8rem; opacity: 0; transition: opacity 0.15s ease; pointer-events: none; z-index: 10; }
    .likert-label-tooltip:hover::after { opacity: 1; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="./dist/jspsych.js"></script>
  <script src="./dist/plugin-html-button-response.js"></script>
  <script src="./dist/plugin-survey.js"></script>
  <script src="./dist/plugin-survey-likert.js"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.5.0/dist/index.browser.min.js"></script>
</head>
<body>
  <div id="jspsych-target"></div>
  <script>
(function(){
  const jsPsych = window.jsPsychModule.initJsPsych({ display_element: 'jspsych-target', show_progress_bar: true, auto_update_progress_bar: false });
  
  // 「Completion Progress」を「進捗状況」に置換（進捗バーが生成されたら処理）
  (function setProgressLabel(){
    const setLabel = () => {
      const span = document.querySelector('#jspsych-progressbar-container span');
      if (span) { span.innerHTML = '進捗状況'; return true; }
      return false;
    };
    if (!setLabel()) {
      const mo = new MutationObserver((_, obs) => { if (setLabel()) obs.disconnect(); });
      mo.observe(document.body, { childList: true, subtree: true });
    }
  })();
  
  const SD3 = {
    M: ["他の誰かに自分の秘密を教えないということは賢明なことだ。","自分の思い通りになるように，賢く周りの人々を扱いたい。","とにかく，重要な人物は自分の味方に付けておいたほうが良い。","将来その人が自分の役に立つかもしれないので，人との直接の争いは避けるようにしている。","後になって誰かに対して利用できるような情報に目を配っておくことは賢明なことだ。","誰かに復讐するなら，それに最適な時が来るまでじっと待つべきだ。","自分の良い評判を守るために，他の人に秘密にしなければならないことがある。","自分の計画が，他の誰かの利益ではなく自分の利益になるように取り計らっている。","ほとんどの人々は簡単に騙されたり，操られたりしてしまうものだ。"],
    N: ["周りの人は私を生まれながらのリーダーだと思っている。","私は注目の的になることが嫌いだ。","私なしではグループの多くの活動が滞ってしまう。","周りの人がそう言っているので私は特別な人間なのだと思う。","私は地位の高い重要な人物と親しくなるのを好んでいる。","私は褒められると恥ずかしくなってしまう。","私はこれまでに著名な人物にたたえられたことがある。","私は平均的でたいしたことのない人間だ。","私は自分が受けるに値する尊敬を集めるべき人間だ。"],
    P: ["私は目上の人に仕返しや報復をしたいと思うことがある。","私は物騒な状況に飛び込むようなことはしない。","報復は，即座に，冷酷に行うものだ。","私は他人からよく手に負えないと言われる。","私は他人につらく当たっても平気だというのが実際のところだ。","私をからかう者はいつまでもその行為を後悔することになる。","私は人に迷惑をかけるような問題を起こしていない。","私は後先考えずに，ほとんど知らない異性と関係を持つのを楽しむことがある。","私は誰に何を言っても，欲しいものを手に入れる。"]
  };
  
  const REVERSED = new Set([11, 15, 17, 20, 25]);
  
  const PAPER_MEANS = { M: 3.53, N: 2.27, P: 2.43 };
  
  const updateProgressBar = (fraction) => {
    const barInner = document.querySelector('#jspsych-progressbar-inner');
    if (barInner) barInner.style.width = `${Math.round(Math.max(0, Math.min(1, fraction)) * 100)}%`;
  };
  
  function computeScores(responses) {
    const scored = {};
    for (let i = 1; i <= 27; i++) {
      const v = responses[i - 1];
      const num = (v === undefined || v === null) ? null : (typeof v === 'number' ? v + 1 : parseInt(String(v).match(/^\d+/)[0], 10));
      scored[i] = (num === null) ? null : (REVERSED.has(i) ? 6 - num : num);
    }
    const meanOf = (idxs) => {
      const arr = idxs.map(i => scored[i]).filter(x => x != null);
      return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;
    };
    return { M: meanOf([1,2,3,4,5,6,7,8,9]), N: meanOf([10,11,12,13,14,15,16,17,18]), P: meanOf([19,20,21,22,23,24,25,26,27]) };
  }
  
  const intro = { type: window.jsPsychHtmlButtonResponse, stimulus: `<div class="card"><h2>SD3-J</h2><h3>日本語版Short Dark Triad</h3><h4>「感情・人格心理学」受講者用</h4><p class="note">
              これはダークトライアド傾向を評価するアンケートです。<br>
              講義内容の理解を促進することを目的に利用されます。<br>
              データは保管されますが，個人が特定されることはありません。<br>
              また，回答の有無が成績に影響することは一切ありません。</p>
            <ul class="small muted">
              回答時間の目安：3〜5分 <br>
              出典<br>下司忠大・小塩真司. (2017). 日本語版Short Dark Triad（SD3-J）の作成. パーソナリティ研究, 26(1), 12–22. https://doi.org/10.2132/personality.26.1.2
              </ul></div>`, choices: ['開始'] };
  
  const demographics = { type: window.jsPsychSurvey, survey_json: { showQuestionNumbers: false, pages: [{name: 'demographics', elements: [{type: 'text', name: 'age', title: '年齢', inputType: 'number', isRequired: true}, {type: 'dropdown', name: 'gender', title: '性別', isRequired: true, choices: ['男性','女性','その他','未回答']}]}], pageNextText: '次へ', completeText: '次へ' }, on_finish: (data) => { const r = data.response||{}; jsPsych.data.addProperties({ age: r.age||'', gender: r.gender||'' }); } };
  
  const allItems = [];
  SD3.M.forEach((t, i) => allItems.push({idx: i+1, domain: 'M', text: t}));
  SD3.N.forEach((t, i) => allItems.push({idx: 9+i+1, domain: 'N', text: t}));
  SD3.P.forEach((t, i) => allItems.push({idx: 18+i+1, domain: 'P', text: t}));
  
  function shuffleInPlace(a) { for (let i=a.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  shuffleInPlace(allItems);
  
  const pages = [allItems.slice(0, 9), allItems.slice(9, 18), allItems.slice(18, 27)];
  
  const likertPages = pages.map((items, k) => ({
    type: window.jsPsychSurveyLikert,
    preamble: `<div class="card"><b>質問 ${k*9+1}–${k*9+items.length} / 27</b><p style="margin:0.5rem 0 0; font-size:0.95rem;">各文について、どの程度同意するかを示してください。<br>
      選択肢：<br>
      1=全くそう思わない<br>
      2=そう思わない<br>
      3=どちらかともいえない<br>
      4=そう思う<br>
      5=非常にそう思う</p></div></div>`,
    questions: items.map(it => ({prompt: it.text, labels: ['1','2','3','4','5'], name: `Q${it.idx}`, required: true})),
    button_label: k === 2 ? '結果を見る' : '次へ',
    on_load: () => {
      const opts = ['全くそう思わない','そう思わない','どちらともいえない','そう思う','非常にそう思う'];
      setTimeout(() => {
        document.querySelectorAll('.jspsych-survey-likert-opt-label').forEach((label, i) => {
          if (!label.classList.contains('likert-label-tooltip')) {
            label.classList.add('likert-label-tooltip');
          }
          label.setAttribute('data-tooltip', opts[i % 5]);
        });
      }, 100);
      updateProgressBar((k*9 + items.length) / 27);
    },
    on_finish: () => {}
  }));
  
  const subject_id = jsPsych.randomization.randomID(10);
  const save_data = { type: window.jsPsychPipe, action: 'save', experiment_id: 'GyvSHLaKTiph', filename: `${subject_id}.csv`, data_string: () => jsPsych.data.get().csv() };
  
  const results = {
    type: window.jsPsychHtmlButtonResponse,
    stimulus: () => {
      const trials = jsPsych.data.get().filter({trial_type:'survey-likert'}).values();
      const responses = new Array(27).fill(null);
      trials.forEach(tr => {
        const resp = tr.response||{};
        Object.entries(resp).forEach(([name, idx]) => {
          const n = parseInt(name.replace('Q',''), 10);
          if (n >= 1 && n <= 27) responses[n - 1] = Number(idx) + 1;
        });
      });
      const s = computeScores(responses);
      const fmt = v => (v == null ? '-' : v.toFixed(2));
      const rowsHtml = `<tr><td>マキャベリアニズム (M)</td><td>${fmt(s.M)}</td><td>${fmt(PAPER_MEANS.M)}</td></tr><tr><td>自己愛傾向 (N)</td><td>${fmt(s.N)}</td><td>${fmt(PAPER_MEANS.N)}</td></tr><tr><td>サイコパシー傾向 (P)</td><td>${fmt(s.P)}</td><td>${fmt(PAPER_MEANS.P)}</td></tr>`;
      return `<div class="card"><h2>結果</h2><div class="chart-wrap"><canvas id="sd3-radar"></canvas></div><div class="small muted" style="margin-top:0.5rem; font-size:0.8rem;">注：下司忠大・小塩真司. (2017). 日本語版Short Dark Triad（SD3-J）の作成. パーソナリティ研究, 26(1), 12–22. https://doi.org/10.2132/personality.26.1.2</div><table><thead><tr><th>特性</th><th>あなた</th><th>論文の平均</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>`;
    },
    choices: ['終了'],
      on_finish: () => {
        window.location.href = 'https://mshrymgc.github.io/epp_scales/';
      },
    on_load: () => {
      const trials = jsPsych.data.get().filter({trial_type:'survey-likert'}).values();
      const responses = new Array(27).fill(null);
      trials.forEach(tr => {
        const resp = tr.response||{};
        Object.entries(resp).forEach(([name, idx]) => {
          const n = parseInt(name.replace('Q',''), 10);
          if (n >= 1 && n <= 27) responses[n - 1] = Number(idx) + 1;
        });
      });
      const s = computeScores(responses);
      const palette = {selfBorder:'#1976D2', selfFill:'rgba(25,118,210,0.15)', normBorder:'#D32F2F', normFill:'rgba(211,47,47,0.15)'};
      const canvas = document.getElementById('sd3-radar');
      if (canvas) {
        const wrap = canvas.parentElement;
        canvas.width = wrap.offsetWidth;
        canvas.height = wrap.offsetHeight;
      }
      new Chart(document.getElementById('sd3-radar').getContext('2d'), {
        type: 'radar',
        data: {
          labels: ['マキャベリアニズム','自己愛傾向','サイコパシー傾向'],
          datasets: [
            {label: 'あなた', data: [s.M, s.N, s.P], fill:true, borderColor: palette.selfBorder, backgroundColor: palette.selfFill, borderWidth: 2.2, tension: 0, pointRadius: 2},
            {label: '論文の平均', data: [PAPER_MEANS.M, PAPER_MEANS.N, PAPER_MEANS.P], fill:true, borderColor: palette.normBorder, backgroundColor: palette.normFill, borderWidth: 2.2, tension: 0, pointRadius: 2}
          ]
        },
        options: { responsive: false, maintainAspectRatio: false, scales: { r: {min: 1, max: 5, ticks: {stepSize: 1}} }, plugins: {legend: {position: 'bottom'}}, elements: {line: {tension: 0}} }
      });
    }
  };
  
  jsPsych.run([intro, demographics, ...likertPages, save_data, results]);
})();
  </script>
</body>
</html>
