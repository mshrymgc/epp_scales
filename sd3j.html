<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>SD3-J（日本語版 Short Dark Triad, 27項目）</title>
  <!-- jsPsych base CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/css/jspsych.css" />
  <!-- Survey (for demographics) -->
  <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@1.0.1/css/survey.css" />
  <style>
    /* ===== style：bfi2sj.html に合わせる（軽量版） ===== */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Noto Sans JP', sans-serif; }
    .note { font-size: 0.95rem; color: #333; line-height: 1.6; }
    .small { font-size: 0.85rem; }
    .muted { color:#666 }
    .jspsych-content { max-width: 1150px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,.04) }
    details summary { cursor: pointer; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: .45rem .4rem; border-bottom: 1px solid #eee; text-align:left; }

    /* Likert ラベルを小さめに（中間は空ラベル） */
    .jspsych-survey-likert .jspsych-survey-likert-opt-label { font-size: 12px; line-height: 1.2; min-width: 4.2em; white-space: normal; }
    .jspsych-survey-likert .jspsych-survey-likert-statement { font-size: .98rem; }

    /* ダークモードを強制しない */
    :root { color-scheme: light; }
    body.dark { background:#000; color:#fff; }
    body.dark .card { background:#111; border-color:#333; color:#fff; }
    body.dark a { color:#9cd3ff; }
    body.dark .muted { color:#bbb }
      /* Chart responsive wrappers */
    .chart-wrap{ position:relative; width:100%; height:46vh; max-height:420px; }
    @media (max-width: 600px){
      .chart-wrap{ height:48vh; max-height:360px; }
    }
  </style>

  <!-- Polyfill for import maps -->
  <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>

  <!-- Import map -->
  <script type="importmap">
  {
    "imports": {
      "jspsych": "https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/index.js",
      "@jspsych/plugin-html-button-response": "https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-button-response@2.0.0/dist/index.js",
      "@jspsych/plugin-survey": "https://unpkg.com/@jspsych/plugin-survey@1.0.1/dist/index.js",
      "@jspsych/plugin-survey-likert": "https://cdn.jsdelivr.net/npm/@jspsych/plugin-survey-likert@2.0.0/dist/index.js"
    }
  }
  </script>
  <!-- Chart.js for radar chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="jspsych-target"></div>

  <script type="module">
    // ===== 手動ダークテーマ (?theme=dark で有効) =====
    (function setTheme(){
      try {
        const params = new URLSearchParams(location.search);
        if ((params.get('theme')||'').toLowerCase() === 'dark') document.body.classList.add('dark');
      } catch(e){}
    })();

    import { initJsPsych } from 'jspsych';
    import htmlButton from '@jspsych/plugin-html-button-response';
    import survey from '@jspsych/plugin-survey';
    import surveyLikert from '@jspsych/plugin-survey-likert';

    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      show_progress_bar: true,
      auto_update_progress_bar: false
    });

    // 進捗バーのラベル差し替え
    (function setProgressLabel(){
      const setLabel = () => {
        const span = document.querySelector('#jspsych-progressbar-container span');
        if (span) { span.innerHTML = '進捗状況'; return true; }
        return false;
      };
      if (!setLabel()) {
        const mo = new MutationObserver((_, obs) => { if (setLabel()) obs.disconnect(); });
        mo.observe(document.body, { childList: true, subtree: true });
      }
    })();

    // ===== SD3-J 項目（下司・小塩, 2017 / Appendix 1） =====
    // ドメイン: M=マキャベリアニズム, N=自己愛傾向, P=サイコパシー傾向
    const SD3 = {
      M: [
        '他の誰かに自分の秘密を教えないということは賢明なことだ。',
        '自分の思い通りになるように，賢く周りの人々を扱いたい。',
        'とにかく，重要な人物は自分の味方に付けておいたほうが良い。',
        '将来その人が自分の役に立つかもしれないので，人との直接の争いは避けるようにしている。',
        '後になって誰かに対して利用できるような情報に目を配っておくことは賢明なことだ。',
        '誰かに復讐するなら，それに最適な時が来るまでじっと待つべきだ。',
        '自分の良い評判を守るために，他の人に秘密にしなければならないことがある。',
        '自分の計画が，他の誰かの利益ではなく自分の利益になるように取り計らっている。',
        'ほとんどの人々は簡単に騙されたり，操られたりしてしまうものだ。'
      ],
      N: [
        '周りの人は私を生まれながらのリーダーだと思っている。',
        '私は注目の的になることが嫌いだ。', // 逆転
        '私なしではグループの多くの活動が滞ってしまう。',
        '周りの人がそう言っているので私は特別な人間なのだと思う。',
        '私は地位の高い重要な人物と親しくなるのを好んでいる。',
        '私は褒められると恥ずかしくなってしまう。', // 逆転
        '私はこれまでに著名な人物にたたえられたことがある。',
        '私は平均的でたいしたことのない人間だ。', // 逆転
        '私は自分が受けるに値する尊敬を集めるべき人間だ。'
      ],
      P: [
        '私は目上の人に仕返しや報復をしたいと思うことがある。',
        '私は物騒な状況に飛び込むようなことはしない。', // 逆転
        '報復は，即座に，冷酷に行うものだ。',
        '私は他人からよく手に負えないと言われる。',
        '私は他人につらく当たっても平気だというのが実際のところだ。',
        '私をからかう者はいつまでもその行為を後悔することになる。',
        '私は人に迷惑をかけるような問題を起こしていない。', // 逆転
        '私は後先考えずに，ほとんど知らない異性と関係を持つのを楽しむことがある。',
        '私は誰に何を言っても，欲しいものを手に入れる。'
      ]
    };

    // 逆転項目（1..27 の通し番号で指定）: N2, N6, N8, P2, P7
    const REVERSED = new Set([11, 15, 17, 20, 25]); // N2, N6, N8, P2, P7 (通し番号) ;
    // 上の書き方：M(1-9), N(10-18 -> 10+index), P(19-27 -> 19+index)

    // エンドポイントのみラベル
    const LABELS = ['全く当てはまらない', '', '', '', '非常にあてはまる'];

    // ===== 導入 =====
    const intro = {
      type: htmlButton,
      stimulus: `
        <div class="card">
          <h2>SD3-J（日本語版 Short Dark Triad・27項目）</h2>
          <p class="note">
            以下の各文について，あなたにどの程度あてはまるかをお答えください。<br>
            選択肢は左から右へ <b>「全く当てはまらない」→「非常にあてはまる」</b> の5段階です。<br>
            中間の選択肢にはラベルを表示していません。すべての項目に回答してください（未回答不可）。
          </p>
          <ul class="small muted">
            所要時間の目安：3〜5分／データは匿名で扱われます。
          </ul>
        </div>
      `,
      choices: ['開始']
    };

    // ===== 最初に年齢・性別 =====
    const demographics = {
      type: survey,
      survey_json: {
        showQuestionNumbers: false,
        widthMode: 'static',
        pages: [{
          name: 'demographics',
          elements: [
            { type: 'text', name: 'age', title: '年齢', inputType: 'number', min: 0, max: 120, isRequired: true },
            { type: 'dropdown', name: 'gender', title: '性別', isRequired: true, choices: ['男性','女性','その他','未回答'] }
          ]
        }],
        pageNextText: '次へ', pagePrevText: '戻る', completeText: '次へ'
      },
      on_finish: (data) => {
        const r = data.response || {};
        jsPsych.data.addProperties({ age: r.age || '', gender: r.gender || '' });
      }
    };

    // ===== 27項目をフラット化 → グローバルにシャッフル → 9項目ずつ3ページ =====
    const allItems = [];
    // M1..M9
    SD3.M.forEach((t, i) => allItems.push({ idx: i+1, code: `M${i+1}`, domain: 'M', text: t }));
    // N1..N9 → 通し番号 10..18（後で逆転指定で使用）
    SD3.N.forEach((t, i) => allItems.push({ idx: 9 + i + 1, code: `N${i+1}`, domain: 'N', text: t }));
    // P1..P9 → 通し番号 19..27
    SD3.P.forEach((t, i) => allItems.push({ idx: 18 + i + 1, code: `P${i+1}`, domain: 'P', text: t }));

    function shuffleInPlace(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    shuffleInPlace(allItems);

    const pages = [ allItems.slice(0,9), allItems.slice(9,18), allItems.slice(18,27) ];

    const likertPages = pages.map((items, k) => ({
      type: surveyLikert,
      preamble: `<div class="card"><b>質問 ${k*9+1}–${k*9+items.length} / 27</b><div class="small muted">該当する選択肢を1つ選んでください（中間ラベルなし）。</div></div>`,
      questions: items.map((it, i) => ({
        prompt: it.text,
        labels: LABELS,
        name: `Q${it.idx}`,
        required: true
      })),
      randomize_question_order: false, // すでに全体をシャッフル済み
      button_label: '次へ',
      on_finish: () => jsPsych.setProgressBar((k*9 + pages[k].length) / 27)
    }));

    // ===== スコア計算（平均 1..5） =====
    function computeScores(){
      const trials = jsPsych.data.get().filter({trial_type:'survey-likert'}).values();
      const merged = Object.assign({}, ...trials.map(v => v.response||{}));
      const raw = {}; // 1..5
      for (let i=1;i<=27;i++){
        const v = merged[`Q${i}`];
        raw[i] = (typeof v === 'number' && isFinite(v)) ? (v+1) : null; // 0..4 → 1..5
      }
      const scored = {};
      for (let i=1;i<=27;i++){
        const val = raw[i];
        scored[i] = (val==null) ? null : (REVERSED.has(i) ? (6 - val) : val);
      }
      function meanOf(idxs){
        const arr = idxs.map(i => scored[i]).filter(x => x!=null);
        return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null;
      }
      return {
        M: meanOf([1,2,3,4,5,6,7,8,9]),
        N: meanOf([10,11,12,13,14,15,16,17,18]),
        P: meanOf([19,20,21,22,23,24,25,26,27])
      };
    }

    // ===== 結果画面（シンプルな表のみ） =====
    const resultScreen = {
      type: htmlButton,
      stimulus: `
        <div class=\"card\">
          <h2>回答ありがとうございました</h2>
          <p class=\"small muted\">以下はあなたの3特性（1〜5）の平均値です。値が高いほど，当該特性の傾向が強いことを示します。</p>
          <div class=\"chart-wrap\"><canvas id=\"sd3-radar\"></canvas></div>
          <p class=\"small muted\">外周=5。<b>青</b>：あなた ／ <b>橙</b>：論文の平均（SD3-J, n=189）。</p>
          <table>
            <thead><tr><th>特性</th><th>あなた</th><th>論文の平均</th></tr></thead>
            <tbody id=\"sd3-rows\"></tbody>
          </table>
          <p class=\"small muted\">備考：参照平均は下司・小塩（2017）Table 2 の SD3-J 平均値。</p>
        </div>
      `,
      choices: ['終了'],
      on_load: () => {
        const s = computeScores();
        const fmt = v => (v==null?'-':v.toFixed(2));
        const PAPER_MEANS = { M: 3.53, N: 2.27, P: 2.43 }; // Shimotsukasa & Oshio (2017) Table 2 SD3-J
        const rowsHtml = `
          <tr><td>マキャベリアニズム (M)</td><td>${fmt(s.M)}</td><td>${fmt(PAPER_MEANS.M)}</td></tr>
          <tr><td>自己愛傾向 (N)</td><td>${fmt(s.N)}</td><td>${fmt(PAPER_MEANS.N)}</td></tr>
          <tr><td>サイコパシー傾向 (P)</td><td>${fmt(s.P)}</td><td>${fmt(PAPER_MEANS.P)}</td></tr>`;
        document.getElementById('sd3-rows').innerHTML = rowsHtml;
        jsPsych.data.addProperties({ SD3J_M: s.M, SD3J_N: s.N, SD3J_P: s.P });

        // ---- Radar chart ----
        const isDark = document.body.classList.contains('dark');
        const palette = isDark
          ? { selfBorder:'#4FC3F7', selfFill:'rgba(79,195,247,0.18)', normBorder:'#FFB74D', normFill:'rgba(255,183,77,0.18)' }
          : { selfBorder:'#1976D2', selfFill:'rgba(25,118,210,0.15)', normBorder:'#D32F2F', normFill:'rgba(211,47,47,0.15)' };
        const ctx = document.getElementById('sd3-radar').getContext('2d');
        const labels = ['M（マキャベリアニズム）','N（自己愛傾向）','P（サイコパシー傾向）'];
        const yourData = [s.M, s.N, s.P].map(v => v ?? null);
        const normData = [PAPER_MEANS.M, PAPER_MEANS.N, PAPER_MEANS.P];
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels,
            datasets: [
              { label: 'あなた', data: yourData, borderColor: palette.selfBorder, backgroundColor: palette.selfFill, pointRadius: 3 },
              { label: '論文の平均（SD3-J）', data: normData, borderColor: palette.normBorder, backgroundColor: palette.normFill, pointRadius: 3 }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { r: { min: 1, max: 5, ticks: { stepSize: 1 } } }
          }
        });
      }
    };

    // ===== 実行 =====
    const timeline = [intro, demographics, ...likertPages, resultScreen];
    jsPsych.run(timeline);
  </script>
</body>
</html>
