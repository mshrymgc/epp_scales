<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>HEXACO-60</title>
  <!-- jsPsych base CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/css/jspsych.css" />
  <!-- Survey (for demographics only) -->
  <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@1.0.1/css/survey.css" />
  <style>
    
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Noto Sans JP', sans-serif; }
    .note { font-size: 0.95rem; color: #333; line-height: 1.6; }
    .small { font-size: 0.85rem; }
    .muted { color:#666 }
    .footer { margin-top: 2rem; font-size: .8rem; color:#666 }
    .jspsych-content { max-width: 1150px; }
    .grid { display:grid; gap: 1rem }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,.04) }
    .danger { color:#b00020 }
    details summary { cursor: pointer; }
    table { border-collapse: collapse; }
    th, td { padding: .4rem .3rem; border-bottom: 1px solid #eee; }
    /* Likert ラベルを小さめに */
    .jspsych-survey-likert .jspsych-survey-likert-opt-label { font-size: 12px; line-height: 1.2; }
    .jspsych-survey-likert .jspsych-survey-likert-statement { font-size: 0.95rem; }
    /* ===== Dark theme support (force white text on black bg) ===== */
    :root { color-scheme: light; } /* ダークモードを無効化 */
    body.dark { background:#000; color:#fff; }
    body.dark .card { background:#111; border-color:#333; color:#fff; }
    body.dark a { color:#9cd3ff; }
    body.dark .muted { color:#bbb }
    body.dark table th, body.dark table td { border-color:#333; }
    /* Chart responsive wrappers */
    .chart-wrap{ position:relative; width:100%; height:46vh; max-height:420px; }
    .chart-wrap.facet{ height:60vh; max-height:560px; }
    @media (max-width: 600px){
    .chart-wrap{ height:48vh; max-height:360px; }
    .chart-wrap.facet{ height:64vh; max-height:520px; }
    .jspsych-content { padding: 0 16px; }
    .card{ padding: .9rem; }
    .jspsych-survey-likert .jspsych-survey-likert-opt-label{ font-size: 11px; }
    .jspsych-survey-likert .jspsych-survey-likert-statement{ font-size: .95rem; }
}
  </style>

  <!-- Polyfill for import maps -->
  <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>

  <!-- Import map -->
  <script type="importmap">
  {
    "imports": {
      "jspsych": "https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/index.js",
      "@jspsych/plugin-html-button-response": "https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-button-response@2.0.0/dist/index.js",
      "@jspsych/plugin-survey": "https://unpkg.com/@jspsych/plugin-survey@1.0.1/dist/index.js",
      "@jspsych/plugin-survey-likert": "https://cdn.jsdelivr.net/npm/@jspsych/plugin-survey-likert@2.0.0/dist/index.js"
    }
  }
  </script>

  <!-- Chart.js for radar chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="jspsych-target"></div>

  <script type="module">
  import { initJsPsych } from 'jspsych';
  // ===== Theme (default light; allow manual dark with ?theme=dark) =====
  (function setTheme(){
    try {
      const params = new URLSearchParams(location.search);
      // デフォルトはライト固定。?theme=dark のときだけ手動でダーク適用
      if (params.get('theme') && params.get('theme').toLowerCase() === 'dark') {
        document.body.classList.add('dark');
      }
    } catch(e){}
  })();
    import jsPsychHtmlButtonResponse from '@jspsych/plugin-html-button-response';
    import jsPsychSurvey from '@jspsych/plugin-survey';
    import jsPsychSurveyLikert from '@jspsych/plugin-survey-likert';

    // ====== 出典（ノーム） ======
    const normCitation = {
      label_base: '日本人サンプル（Wakabayashi, 2014, Japanese Psychological Research, Table 1）',
      url: 'https://onlinelibrary.wiley.com/doi/pdf/10.1111/jpr.12045'
    };

    // ====== 日本人ノーム（男女別／全体）—— Table 1 の合計得点（M） ======
    // 注：ノームは HEXACO-PI-R 100（ドメイン32・ファセット8項目）の合計得点。
    //     参加者は HEXACO-60（ドメイン10項目・ファセット2〜4項目）の合計得点。
    //     絶対値レンジは異なるため、比較は参照目的です。
    const norms = {
      total: {
        domain: { H: 106.6, E: 109.9, X: 100.7, A: 91.5,  C: 95.2,  O: 100.8 },
        facet: {
          H_Sincerity: 22.4, H_Fairness: 29.7, H_GreedAvoidance: 25.8, H_Modesty: 28.7,
          E_Fearfulness: 26.3, E_Anxiety: 28.5, E_Dependence: 26.9, E_Sentimentality: 28.1,
          X_Expressiveness: 26.1, X_SocialBoldness: 20.8, X_Sociability: 28.3, X_Liveliness: 25.5,
          A_Forgiveness: 20.0, A_Gentleness: 23.3, A_Flexibility: 25.0, A_Patience: 23.2,
          C_Organization: 22.2, C_Diligence: 23.4, C_Perfectionism: 26.7, C_Prudence: 23.0,
          O_AestheticAppreciation: 25.8, O_Inquisitiveness: 24.7, O_Creativity: 21.2, O_Unconventionality: 29.1
        }
      },
      male: {
        domain: { H: 101.9, E: 105.8, X: 99.0,  A: 90.3,  C: 95.3,  O: 101.7 },
        facet: {
          H_Sincerity: 21.7, H_Fairness: 27.8, H_GreedAvoidance: 24.7, H_Modesty: 27.8,
          E_Fearfulness: 25.5, E_Anxiety: 27.9, E_Dependence: 25.7, E_Sentimentality: 26.7,
          X_Expressiveness: 25.3, X_SocialBoldness: 20.8, X_Sociability: 28.0, X_Liveliness: 25.0,
          A_Forgiveness: 19.7, A_Gentleness: 23.2, A_Flexibility: 24.5, A_Patience: 22.9,
          C_Organization: 22.4, C_Diligence: 23.4, C_Perfectionism: 26.5, C_Prudence: 23.0,
          O_AestheticAppreciation: 24.4, O_Inquisitiveness: 25.9, O_Creativity: 21.3, O_Unconventionality: 29.5
        }
      },
      female: {
        domain: { H: 112.0, E: 114.7, X: 102.7, A: 92.8,  C: 95.1,  O: 100.4 },
        facet: {
          H_Sincerity: 23.1, H_Fairness: 31.9, H_GreedAvoidance: 27.1, H_Modesty: 29.7,
          E_Fearfulness: 27.2, E_Anxiety: 29.3, E_Dependence: 28.4, E_Sentimentality: 29.8,
          X_Expressiveness: 27.0, X_SocialBoldness: 20.8, X_Sociability: 28.7, X_Liveliness: 26.2,
          A_Forgiveness: 20.3, A_Gentleness: 23.6, A_Flexibility: 25.5, A_Patience: 23.4,
          C_Organization: 22.0, C_Diligence: 23.3, C_Perfectionism: 26.9, C_Prudence: 22.9,
          O_AestheticAppreciation: 27.4, O_Inquisitiveness: 23.4, O_Creativity: 21.0, O_Unconventionality: 28.6
        }
      }
    };

    // 表示ラベル（日本語）
    const domainLabelsJA = { H:'誠実‐謙虚性', E:'情動性', X:'外向性', A:'協調性', C:'勤勉性', O:'開放性' };

    // ファセットの並び（日本語表記）→ レーダー & ノーム参照のキー
    const facetOrder = [
      { key:'H_Sincerity', label:'率直さ（誠実さ）', dom:'H' },
      { key:'H_Fairness', label:'公正さ', dom:'H' },
      { key:'H_GreedAvoidance', label:'強欲回避', dom:'H' },
      { key:'H_Modesty', label:'謙虚さ', dom:'H' },

      { key:'E_Fearfulness', label:'恐れやすさ', dom:'E' },
      { key:'E_Anxiety', label:'不安傾向', dom:'E' },
      { key:'E_Dependence', label:'依存傾向', dom:'E' },
      { key:'E_Sentimentality', label:'感傷性', dom:'E' },

      { key:'X_Expressiveness', label:'表出性（Expressiveness）', dom:'X' },
      { key:'X_SocialBoldness', label:'社会的大胆さ', dom:'X' },
      { key:'X_Sociability', label:'社交性', dom:'X' },
      { key:'X_Liveliness', label:'活発さ', dom:'X' },

      { key:'A_Forgiveness', label:'赦しやすさ', dom:'A' },
      { key:'A_Gentleness', label:'温和さ', dom:'A' },
      { key:'A_Flexibility', label:'柔軟さ', dom:'A' },
      { key:'A_Patience', label:'我慢強さ', dom:'A' },

      { key:'C_Organization', label:'組織性', dom:'C' },
      { key:'C_Diligence', label:'勤勉さ', dom:'C' },
      { key:'C_Perfectionism', label:'完璧主義', dom:'C' },
      { key:'C_Prudence', label:'慎重さ', dom:'C' },

      { key:'O_AestheticAppreciation', label:'審美的感受性', dom:'O' },
      { key:'O_Inquisitiveness', label:'探究心', dom:'O' },
      { key:'O_Creativity', label:'創造性', dom:'O' },
      { key:'O_Unconventionality', label:'非慣習性', dom:'O' }
    ];

    // ========== 項目テキスト ==========
    const itemTexts_ja = [
      "美術館に行くと，とても退屈してしまう。",
      "最後になってあわてないために，前もって計画を立てて物事の準備をする。",
      "たとえひどく不当な扱いをされた相手に対しても，めったに悪意を抱くことはない。",
      "私は全体的に自分自身にほどよく満足していると感じている。",
      "悪天候のときに旅行をしなければならないとしたら，恐れを感じる。",
      "たとえそうすればうまくいくと思っても，仕事の上で昇進するためにお世辞を言ったりしようとは思わない。",
      "他の国の歴史や政治について学ぶことに興味がある。",
      "目標を達成しようとするときは，しばしば自分をとても激しく追い詰める。",
      "人からときどき，他人に対して批判的すぎると言われる。",
      "集団での話し合いでは，自分の意見を言うことはめったにない。",
      "ちょっとしたことが心配になって，それを抑えることができないことがある。",
      "もし決して捕まらないとわかっているのなら，私は1億円を盗もうと思う。",
      "小説を書いたり，曲を作ったり，絵を描いたりといった，芸術作品を創作することは楽しい。",
      "何かの仕事をするとき，細かい点にはあまり注意を払わない。",
      "ときどき人から，私は頑固すぎると言われる。",
      "一人でやるよりも，積極的な人との関わりを含む仕事の方が好きだ。",
      "苦しい体験に苦しんでいるときには，慰めを与えてくれる人が必要である。",
      "大金を持つことは，自分にとって特に重要なことではない。",
      "とても斬新で慣習にとらわれない考えを考慮することは，<br>時間の無駄だと思う。",
      "私は，よく考えた上でよりも，<br>そのときの気持ち次第で物事を決めることがある。",
      "他の人は，私のことを短気な人間だと思っている。",
      "たいていは，元気で楽天的である。",
      "他の人が泣いているのをみると，私も泣きたくなる。",
      "私は，平均的な人間よりも，優遇される権利があると思う。",
      "もし機会があれば，クラシック音楽の演奏会に行きたい。",
      "仕事をしているとき，ときどき自分がだらしがないために困ってしまうことがある。",
      "私にひどいことをした人に対する私の態度は，「許して忘れる」ことである。",
      "自分は人気がない人間だと感じている。",
      "身体的な危険が迫ると，とても怖い。",
      "もし，何かをある人から手に入れようと思っているときには，その人がくだらない冗談を言っても笑うだろう。",
      "百科事典を読むことを楽しんだことはない。",
      "必要とされる最低限の仕事しかしない。",
      "他の人を判断するときには，甘い（手加減する）傾向がある。",
      "社会的（対人）場面では，たいてい私がはじめに行動する人間である。",
      "他の人ほどは心配性ではない。",
      "たとえどんなに大金でも，賄賂は決して受け取らない。",
      "人から，よく私は優れた想像力を持っていると言われることがある。",
      "たとえ時間がかかっても，自分の仕事ではいつも正確であるようにしている。",
      "人が私に同調しないときは，<br>私はたいてい自分の意見について，かなり柔軟である。",
      "新しい場所に行っていつも最初にすることは，友達を作ることである。",
      "誰かの感情的な支えがないとしても，困難な状況に対処することができる。",
      "高価で贅沢なものを所有することで，多くの楽しみが得られる。",
      "私は，型にはまらない見方をする人が好きである。",
      "行動する前に考えないので，たくさんの失敗をしてしまう。",
      "たいていの人は，私よりもすぐに怒り出す。",
      "たいていの人は，私よりも陽気で活発である。",
      "自分と親しい人が長い間遠くに行ってしまうときには，強い感情を感じる。",
      "私が高い地位にいる重要な人物であることを他の人に知ってほしい。",
      "自分のことを，芸術家タイプとか，創造的なタイプであるとは思わない。",
      "人からしばしば完全主義者だと言われる。",
      "たとえ人がたくさん間違いを犯したときでも，<br>私はめったに否定的なことは言わない。",
      "時々自分は価値のない人間だと感じる。",
      "たとえ非常（緊急）の場合でも，あわてふためいたりすることはない。",
      "誰かに私のたのみを聞いてもらうために，<br>その人を好きなふりをしようとは思わない。",
      "哲学について議論するのは，うんざりである。",
      "私は，何でも計画通りにするよりも，思いついたことをするのが好きである。",
      "人から私が間違っていると言われたとき，<br>私の最初の反応は，相手に同意しないことである。",
      "集団の中にいるとき，しばしばその集団を代表して話をする人間である。",
      "たいていの人がとても感傷的になるような状況でも，私は冷静でいられる。",
      "もし絶対に捕まらないなら，偽札を使ってみたい。"
    ];

    const itemTexts = itemTexts_ja;

    // Likert ラベル（1..5）
    const likertLabelsJA = [
      '全く<br>当てはまらない',
      'あまり<br>当てはまらない',
      'どちらとも<br>言えない',
      'やや<br>当てはまる',
      'とても<br>当てはまる'
    ];

    // 反転項目
    const reverseItems = new Set([1,9,10,12,13,15,19,20,21,24,25,28,30,35,38,41,42,44,46,48,50,52,53,55,56,57,59,60]);

    // ドメイン
    const domainMap = {
      'H': [6,12,18,24,30,36,42,48,54,60],
      'E': [5,11,17,23,29,35,41,47,53,59],
      'X': [4,10,16,22,28,34,40,46,52,58],
      'A': [3,9,15,21,27,33,39,45,51,57],
      'C': [2,8,14,20,26,32,38,44,50,56],
      'O': [1,7,13,19,25,31,37,43,49,55]
    };

    // ファセット（日本語表記 → 項目番号）
    const facetMap = {
      'H': {
        '率直さ（誠実さ）': [6,30,54],
        '公正さ': [12,36,60],
        '強欲回避': [18,42],
        '謙虚さ': [24,48]
      },
      'E': {
        '恐れやすさ': [5,29,53],
        '不安傾向': [11,35],
        '依存傾向': [17,41],
        '感傷性': [23,47,59]
      },
      'X': {
        '表出性（Expressiveness）': [4,28,52],
        '社会的大胆さ': [10,34,58],
        '社交性': [16,40],
        '活発さ': [22,46]
      },
      'A': {
        '赦しやすさ': [3,27],
        '温和さ': [9,33,51],
        '柔軟さ': [15,39,57],
        '我慢強さ': [21,45]
      },
      'C': {
        '組織性': [2,32,50],
        '勤勉さ': [8,26,56],
        '完璧主義': [14,38],
        '慎重さ': [20,44]
      },
      'O': {
        '審美的感受性': [1,25,49,55],
        '探究心': [7,31],
        '創造性': [13,37],
        '非慣習性': [19,43]
      }
    };

    // ========== テスト（自己診断） ==========
    (function selfTests(){
      try {
        console.group('%cHEXACO-60 self-tests','color:#0a0');
        console.assert(itemTexts.length === 60, `Items length must be 60, got ${itemTexts.length}`);
        for (const [dom, arr] of Object.entries(domainMap)) console.assert(arr.length === 10, `Domain ${dom} must have 10 items`);
        const allItems = Object.values(domainMap).flat();
        console.assert(new Set(allItems).size === 60, 'Domain map covers 60 unique items');
        console.assert(facetOrder.every(f=>norms.total.facet.hasOwnProperty(f.key)), 'norms.total.facet has all keys in facetOrder');
        console.assert(facetOrder.every(f=>facetMap[f.dom] && Object.keys(facetMap[f.dom]).includes(f.label)), 'facetMap contains all facet labels in facetOrder');
        // All-3s => each domain sum = 30
        const all3 = Array(60).fill(3);
        const s3 = computeScores(all3);
        Object.entries(s3.domains).forEach(([k,v])=>console.assert(v.sum===30, `All-3s ${k} sum should be 30, got ${v.sum}`));
        // All-1s => expected using reverse counts
        const all1 = Array(60).fill(1);
        const r1 = computeScores(all1);
        for (const [dom, nums] of Object.entries(domainMap)){
          const revCnt = nums.filter(n=>reverseItems.has(n)).length;
          const expected = (nums.length - revCnt)*1 + revCnt*5;
          console.assert(r1.domains[dom].sum === expected, `All-1s ${dom} expected ${expected}, got ${r1.domains[dom].sum}`);
        }
        // Facet check with All-1s
        for (const [dom, fobj] of Object.entries(facetMap)){
          for (const [fname, nums] of Object.entries(fobj)){
            const revCnt = nums.filter(n=>reverseItems.has(n)).length;
            const expected = (nums.length - revCnt)*1 + revCnt*5;
            console.assert(r1.facets[dom][fname].sum === expected, `All-1s ${dom}/${fname} expected ${expected}, got ${r1.facets[dom][fname].sum}`);
          }
        }
        console.groupEnd();
      } catch(e){
        console.error('Self-test error', e);
      }
    })();

    // ========== ユーティリティ ==========
    const chunk = (arr, size) => arr.reduce((acc, _, i) => (i % size ? acc : [...acc, arr.slice(i, i + size)]), []);
    const reverseScore = (raw) => 6 - raw; // raw: 1..5

    function computeScores(responses) {
      const get = (n) => responses[n-1];
      const scoreOf = (n) => reverseItems.has(n) ? (6 - get(n)) : get(n); // 反転後の項目得点（1..5）

      const domains = {};
      for (const [dom, nums] of Object.entries(domainMap)) {
        const vals = nums.map(scoreOf);
        const sum = vals.reduce((a,b)=>a+b,0); // 合計
        domains[dom] = { sum, items: nums };
      }

      const facets = {};
      for (const [dom, fobj] of Object.entries(facetMap)) {
        facets[dom] = {};
        for (const [facet, nums] of Object.entries(fobj)) {
          const vals = nums.map(scoreOf);
          const sum = vals.reduce((a,b)=>a+b,0);
          facets[dom][facet] = { sum, items: nums };
        }
      }
      return { domains, facets };
    }

    // ========== 実験本体 ==========
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      show_progress_bar: true,
      auto_update_progress_bar: false
    });

    // 「Completion Progress」を「進捗状況」に置換（進捗バーが生成されたら処理）
(function setProgressLabel(){
  const setLabel = () => {
    const span = document.querySelector('#jspsych-progressbar-container span');
    if (span) {
      span.innerHTML = '進捗状況';
      return true;
    }
    return false;
  };
  if (!setLabel()) {
    const mo = new MutationObserver((_, obs) => {
      if (setLabel()) obs.disconnect();
    });
    mo.observe(document.body, { childList: true, subtree: true });
  }
})();

    const timeline = [];

    // ウェルカム
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="grid">
          <div class="card">
            <h2>HEXACO-60</h2>
            <h3>「感情・人格心理学」受講者用</h3>
            <p class="note">  
              これはHEXACOパーソナリティモデルを評価する
              60 項目のアンケートであり，講義内容の理解を促進するために利用されます。データは保管されますが，個人が特定されることはなく，回答の有無が成績に影響することは一切ありません。<br><br>
              次のページから並んでいる項目の内容について，自分にどの程度あてはまっているか，あてはまっていないかを考えて，各文の下の選択肢から一つを選んでください。なお，<strong>「どちらでもない」はできるだけ選択しないようにしてください。</strong>（どうしてもどちらとも決められない場合にのみ選択してください）<br>
            </p>
            <ul class="small muted">
              回答時間の目安：10〜15分 <br>
              すべての項目に回答してください（未回答不可）<br><br>
              出典<br>Wakabayashi, A. (2014). A sixth personality domain that is independent of the Big Five domains: The psychometric properties of the HEXACO Personality Inventory in a Japanese sample. Japanese Psychological Research, 56(3), 211–223. https://doi.org/10.1111/jpr.12045
            </ul>
          </div>
        </div>
      `,
      choices: ['はじめる']
    });

    // 属性（年齢・性別のみ）
    timeline.push({
      type: jsPsychSurvey,
      survey_json: {
        showQuestionNumbers: false,
        pages: [{
          name: 'demographics',
          elements: [
            { type: 'text', name: 'age', title: '年齢', inputType: 'number', min: 0, max: 120, isRequired: true },
            { type: 'dropdown', name: 'gender', title: '性別', isRequired: true, choices: ['男性','女性','その他','未回答'] }
          ]
        }],
        pageNextText: '次へ', pagePrevText: '戻る', completeText: '次へ'
      },
      on_finish: (data) => {
        const r = data.response || {};
        jsPsych.data.addProperties({ age: r.age || '', gender: r.gender || '' });
      }
    });

    // Likert（10問×6ページ）
    const totalItems = itemTexts.length;
    const perPage = 10;
    const pages = chunk(itemTexts, perPage);

    pages.forEach((pageItems, pageIdx) => {
      const start = pageIdx * perPage + 1;
      const end = Math.min(totalItems, (pageIdx + 1) * perPage);
      timeline.push({
        type: jsPsychSurveyLikert,
        preamble: `<div class="card"><b>質問 ${start}–${end} / ${totalItems}</b><div class="small muted">各項目に対して最も近い選択肢を選んでください。</div></div>`,
        randomize_question_order: false,
        button_label: '次へ',
        questions: pageItems.map((txt, i) => ({
          prompt: `<div class=\"note\">${txt}</div>`,
          labels: likertLabelsJA,
          required: true,
          name: `Q${start + i}`
        })),
        on_finish: () => {
          const progress = (end / totalItems);
          jsPsych.setProgressBar(progress);
        }
      });
    });

    // 終了 & 得点化（画面表示＋レーダーチャート：因子＆ファセット）
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: () => {
        // Likert の全レスポンス取得（0ベース→+1）
        const trials = jsPsych.data.get().filter({ trial_type: 'survey-likert' }).values();
        const responses = new Array(60).fill(null);
        trials.forEach(tr => {
          const resp = tr.response || {};
          Object.entries(resp).forEach(([name, idx]) => {
            const n = parseInt(name.replace('Q',''), 10);
            responses[n-1] = Number(idx) + 1;
          });
        });

        if (responses.some(v => v === null)) {
          return `<div class=\"card\"><p>未回答の項目があります。<b>すべての項目</b>に回答してください。</p></div>`;
        }

        const scored = computeScores(responses);
        const domRows = Object.entries(scored.domains).map(([dom, v]) => `
          <tr><td>${domainLabelsJA[dom]} (${dom})</td><td style=\"text-align:right\">${v.sum}</td></tr>
        `).join('');

        // レーダー用キャンバス
        return `
          <div class="card">
            <h3>回答ありがとうございました。</h3>
            <p>6 因子の<strong>合計スコア</strong>（各因子10項目・1〜5点×10＝最大50点）</p>
            <table style="width:100%">
              <thead><tr><th style="text-align:left">因子</th><th style="text-align:right">合計</th></tr></thead>
              <tbody>${domRows}</tbody>
            </table>

            <h4 style="margin-top:1rem">レーダーチャート（因子：自分 vs 日本人ノーム）</h4>
            <div class="chart-wrap domain"><canvas id="hexaco-radar-domain"></canvas></div>

            <h4 style="margin-top:1rem">レーダーチャート（ファセット：自分 vs 日本人ノーム）</h4>
            <div class="chart-wrap facet"><canvas id="hexaco-radar-facet"></canvas></div>

            <details id=\"debug-block\" class=\"small\" style=\"margin-top:1rem\">
              <summary>採点内訳を表示（ドメイン/ファセット・逆転処理後）</summary>
              <div id=\"debug-content\"></div>
            </details>

            <div class=\"footer muted" style="margin-top:1rem">
              <div>ノーム出典：${normCitation.label_base}（<a href="${normCitation.url}" target="_blank" rel="noopener noreferrer">PDF</a>）</div>
              <div>備考：ノームは HEXACO-PI-R 100（8項目/ファセット, 32項目/ドメイン）の<strong>合計得点の平均値（Table 1 の M）</strong>を用いています。<br>参加者のスコアは HEXACO-60 の<strong>合計得点</strong>（ドメイン=10項目合計、ファセット=該当項目合計）です。<br>※ 尺度の項目数が異なるため絶対値は一致しません。</div>
              <div>参考：Ashton, M. C., & Lee, K. (2009). The HEXACO–60. JPA, 91(4), 340–345.</div>
            </div>
          </div>
        `;
      },
      choices: ['終了'],
      on_load: () => {
        // responses 再構築
        const trials = jsPsych.data.get().filter({ trial_type: 'survey-likert' }).values();
        const responses = new Array(60).fill(null);
        trials.forEach(tr => {
          const resp = tr.response || {};
          Object.entries(resp).forEach(([name, idx]) => {
            const n = parseInt(name.replace('Q',''), 10);
            responses[n-1] = Number(idx) + 1;
          });
        });
        if (responses.some(v => v === null)) return;

        // 参加者の性別に応じてノームを選択
        const meta = jsPsych.data.get().values().find(v => v.gender !== undefined) || {};
        const g = (meta.gender || '').trim();
        let normSet = norms.total; let normLabel = '日本人サンプル（全体）';
        if (g === '男性') { normSet = norms.male; normLabel = '日本人サンプル（男性）'; }
        else if (g === '女性') { normSet = norms.female; normLabel = '日本人サンプル（女性）'; }

        const { domains, facets } = computeScores(responses);

        // Chart colors depending on theme
        const isDark = document.body.classList.contains('dark');
        const txtColor = isDark ? '#ffffff' : '#000000';
        const gridColor = isDark ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.2)';

        // ===== 因子レーダー =====
        const order = ['H','E','X','A','C','O'];
        const labelsDom = order.map(k => `${domainLabelsJA[k]} (${k})`);
        const selfDom = order.map(k => domains[k].sum);
        const normDom = order.map(k => normSet.domain[k]);
        const ctxD = document.getElementById('hexaco-radar-domain');
        // High-contrast dataset colors to avoid invisible lines (esp. dark mode)
        const palette = isDark
          ? { selfBorder:'#4FC3F7', selfFill:'rgba(79,195,247,0.18)', normBorder:'#FFB74D', normFill:'rgba(255,183,77,0.18)' }
          : { selfBorder:'#1976D2', selfFill:'rgba(25,118,210,0.15)', normBorder:'#D32F2F', normFill:'rgba(211,47,47,0.15)' };
        if (ctxD) new window.Chart(ctxD, {
          type: 'radar',
          data: {
            labels: labelsDom,
            datasets: [
              { label: '自分', data: selfDom, pointRadius: 3, fill: true, borderColor: palette.selfBorder, backgroundColor: palette.selfFill, borderWidth: 2.5, tension: 0 },
              { label: `${normLabel}`, data: normDom, pointRadius: 3, fill: true, borderColor: palette.normBorder, backgroundColor: palette.normFill, borderWidth: 2.5, tension: 0 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { r: { min: 0, max: 160, ticks: { color: txtColor }, pointLabels: { color: txtColor }, grid: { color: gridColor }, angleLines: { color: gridColor } } },
            plugins: { legend: { position: 'bottom', labels: { color: txtColor } }, tooltip: { enabled: true } },
            elements: { line: { borderWidth: 2.5, tension: 0 } }
          }
        });

        // ===== ファセットレーダー（24軸） =====
        const labelsFacet = facetOrder.map(f => `${f.label}`);
        const selfFacet = facetOrder.map(f => {
          const domFacets = facets[f.dom];
          const match = Object.entries(domFacets).find(([fname]) => fname === f.label);
          return match ? match[1].sum : 0;
        });
        const normFacet = facetOrder.map(f => normSet.facet[f.key]);
        // ==== Debug tables (domains & facets, with reverse flags) ====
        try {
          const scoreOf = (n) => reverseItems.has(n) ? (6 - responses[n-1]) : responses[n-1];
          const makeTable = (headers, rows) => {
            const ths = headers.map(h=>`<th>${h}</th>`).join('');
            const trs = rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('');
            return `<table style=\"width:100%; font-size:12px\"><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;
          };
          let domHtml = '';
          const order = ['H','E','X','A','C','O'];
          order.forEach(dom => {
            const items = domainMap[dom];
            const rows = items.map(n=>{
              const raw = responses[n-1];
              const rev = reverseItems.has(n);
              const sc = scoreOf(n);
              return [n, raw, rev?'<span style=\"color:#b00\">R</span>':'', sc];
            });
            const sum = rows.reduce((a,b)=>a+Number(b[3]),0);
            rows.push(['合計','','',`<b>${sum}</b>`]);
            domHtml += `<h5 style=\"margin-top:8px\">${domainLabelsJA[dom]} (${dom})</h5>${makeTable(['項目','素点','R','換算後'], rows)}`;
          });
          let facetHtml = '';
          facetOrder.forEach(f => {
            const nums = (facetMap[f.dom]||{})[f.label]||[];
            const rows = nums.map(n=>{
              const raw = responses[n-1];
              const rev = reverseItems.has(n);
              const sc = scoreOf(n);
              return [n, raw, rev?'<span style=\"color:#b00\">R</span>':'', sc];
            });
            const sum = rows.reduce((a,b)=>a+Number(b[3]||0),0);
            rows.push(['合計','','',`<b>${sum}</b>`]);
            facetHtml += `<h5 style=\"margin-top:8px\">${f.label}</h5>${makeTable(['項目','素点','R','換算後'], rows)}`;
          });
          const dbg = document.getElementById('debug-content');
          if (dbg) dbg.innerHTML = `<div class=\"radar-wrap\"><h4>ドメイン内訳</h4>${domHtml}<h4 style=\"margin-top:12px\">ファセット内訳</h4>${facetHtml}</div>`;
        } catch(e){ console.warn('debug table render failed', e); }

        const ctxF = document.getElementById('hexaco-radar-facet');
        if (ctxF) new window.Chart(ctxF, {
          type: 'radar',
          data: {
            labels: labelsFacet,
            datasets: [
              { label: '自分', data: selfFacet, pointRadius: 2, fill: true, borderColor: palette.selfBorder, backgroundColor: palette.selfFill, borderWidth: 1.8, tension: 0 },
              { label: `${normLabel}`, data: normFacet, pointRadius: 2, fill: true, borderColor: palette.normBorder, backgroundColor: palette.normFill, borderWidth: 1.8, tension: 0 }
            ]
          },
          options: {
            responsive: true,
            scales: { r: { min: 0, max: 32, ticks: { display: false, color: txtColor }, pointLabels: { color: txtColor }, grid: { color: gridColor }, angleLines: { color: gridColor } } },
            plugins: { legend: { position: 'bottom', labels: { color: txtColor } }, tooltip: { enabled: true } },
            elements: { line: { borderWidth: 1.8, tension: 0 } }
          }
        });
      }
    });

    // 実行
    jsPsych.run(timeline);
  </script>
</body>
</html>
