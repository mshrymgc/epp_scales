<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>アイオワギャンブリング課題</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #f5f5f7 0%, #ffffff 100%);
    }

    .jspsych-content {
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    h1 {
      color: #1d1d1f;
      font-size: 1.8rem;
      margin: 0 0 1rem 0;
      font-weight: 700;
      text-align: center;
    }

    h2 {
      color: #0071e3;
      font-size: 1.3rem;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
      font-weight: 600;
    }

    .jspsych-btn {
      background-color: #0071e3;
      color: #fff;
      border: 1px solid #0071e3;
      padding: 0.6rem 1.2rem;
      margin: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .jspsych-btn:hover {
      background-color: #0059b3;
      border-color: #0059b3;
    }

    .status-bar {
      display: flex;
      justify-content: space-around;
      margin: 1rem 0;
      padding: 1rem;
      background: #f5f5f7;
      border-radius: 8px;
    }

    .status-item {
      text-align: center;
    }

    .status-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.3rem;
    }

    .status-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1d1d1f;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .result-item {
      background: #f5f5f7;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .result-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .result-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1d1d1f;
    }

    .result-value.positive {
      color: #34c759;
    }

    .result-value.negative {
      color: #ff3b30;
    }
  </style>
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.5.0/dist/index.browser.min.js"></script>
</head>
<body>
  <div id="jspsych-target"></div>
  <script>
(() => {
  // =====================================
  // 定数とグローバル変数
  // =====================================
  const TRIALS_PER_BLOCK = 16;
  const NUM_BLOCKS = 4;
  const TOTAL_TRIALS = TRIALS_PER_BLOCK * NUM_BLOCKS;
  const INITIAL_MONEY = 2000;

  // デッキ定義
  const baseDeckDefinitions = {
    A: {
      gains: [75, 100, 125],
      losses: [200, 250, 250, 300]
    },
    B: {
      gains: [75, 100, 125],
      losses: [1000, 1250, 1250, 1500]
    },
    C: {
      gains: [25, 50, 75],
      losses: [25, 50, 50, 75, 0, 0, 0, 0, 0, 0, 0, 0]
    },
    D: {
      gains: [25, 50, 75],
      losses: [150, 200, 200, 250, 0, 0, 0, 0, 0, 0, 0, 0]
    }
  };

  // =====================================
  // ユーティリティ関数
  // =====================================
  function detectSystemInfo() {
    const ua = navigator.userAgent;
    let browser = 'Unknown';
    let os = 'Unknown';

    if (ua.indexOf('Firefox') > -1) {
      browser = 'Firefox';
    } else if (ua.indexOf('Opera') > -1 || ua.indexOf('OPR') > -1) {
      browser = 'Opera';
    } else if (ua.indexOf('Trident') > -1) {
      browser = 'Internet Explorer';
    } else if (ua.indexOf('Edge') > -1 || ua.indexOf('Edg') > -1) {
      browser = 'Edge';
    } else if (ua.indexOf('Chrome') > -1) {
      browser = 'Chrome';
    } else if (ua.indexOf('Safari') > -1) {
      browser = 'Safari';
    }

    if (ua.indexOf('Win') > -1) {
      os = 'Windows';
    } else if (ua.indexOf('Mac') > -1) {
      os = 'macOS';
    } else if (ua.indexOf('Linux') > -1) {
      os = 'Linux';
    } else if (ua.indexOf('Android') > -1) {
      os = 'Android';
    } else if (ua.indexOf('iOS') > -1 || ua.indexOf('iPhone') > -1 || ua.indexOf('iPad') > -1) {
      os = 'iOS';
    }

    return { browser, os, userAgent: ua };
  }

  function generateBlockDecks() {
    const blockDecks = [];
    
    for (let i = 0; i < NUM_BLOCKS; i++) {
      // 標準的なIGT: 各ブロックで同じデッキ定義を使用
      // A/B/C/Dの位置と特性は常に固定
      const decks = {};
      Object.keys(baseDeckDefinitions).forEach(key => {
        decks[key] = JSON.parse(JSON.stringify(baseDeckDefinitions[key]));
      });
      blockDecks.push(decks);
    }
    
    return blockDecks;
  }

  // =====================================
  // jsPsych初期化
  // =====================================
  const jsPsych = window.jsPsychModule.initJsPsych({
    display_element: 'jspsych-target'
  });

  // メタデータ設定
  const subjectId = jsPsych.randomization.randomID(10);
  const filename = `${subjectId}.csv`;
  const sessionStart = Date.now();
  const systemInfo = detectSystemInfo();

  jsPsych.data.addProperties({
    subject_id: subjectId,
    timestamp_start: new Date().toISOString(),
    start_timestamp: sessionStart,
    browser: systemInfo.browser,
    os: systemInfo.os,
    user_agent: systemInfo.userAgent,
    task_name: 'IGT',
    total_trials: TOTAL_TRIALS,
    trials_per_block: TRIALS_PER_BLOCK,
    num_blocks: NUM_BLOCKS,
    initial_money: INITIAL_MONEY
  });

  // =====================================
  // タイムラインの構築
  // =====================================
  const timeline = [];

  // ウェルカムページ
  timeline.push({
    type: window.jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="card" style="max-width: 800px;">
        <h1>🎰 アイオワギャンブリング課題</h1>
        <p style="text-align: center; color: #666; margin: 1rem 0;">
          この課題はアイオワギャンブリング課題を体験するためのデモンストレーション実験であり，講義内容の理解を促進するために利用されます。<br>この結果だけで医学的診断を行ったり，あなたの行動傾向を正確に測定することはできませんので注意してください。<br>データは保管されますが，個人が特定されることはなく，回答の有無が成績に影響することは一切ありません。<br>

          この課題では、<strong>4つの札の山から繰り返し選択を行い、利益を最大化する</strong>ことを目指します。<br>
          4つのブロック（各16試行、合計64試行）で構成されます。
        </p>
        <div style="background: #f5f5f7; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
          <p><strong>ゲームの説明</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem; text-align: left;">
            <li>各試行で4つの札の山（A, B, C, D）から1つ選びます</li>
            <li>獲得額と損失額が表示されます</li>
            <li>最後に結果が表示されます</li>
          </ul>
        </div>
      </div>
    `,
    choices: ['開始']
  });

  // 年齢・性別入力
  timeline.push({
    type: window.jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="card" style="max-width: 600px;">
        <h2 style="text-align: center;">参加者情報の入力</h2>
        <div style="margin: 2rem 0;">
          <div style="margin: 1rem 0;">
            <label for="age_input" style="display: block; margin-bottom: 0.5rem;">年齢: <span style="color: red;">*</span></label>
            <input type="number" id="age_input" min="1" max="150" style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px;" />
          </div>
          <div style="margin: 1rem 0;">
            <label for="gender_input" style="display: block; margin-bottom: 0.5rem;">性別: <span style="color: red;">*</span></label>
            <select id="gender_input" style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">-- 選択 --</option>
              <option value="男性">男性</option>
              <option value="女性">女性</option>
              <option value="その他">その他</option>
              <option value="未回答">未回答</option>
            </select>
          </div>
          <div id="error_message" style="color: red; margin-top: 1rem; text-align: center; display: none; font-weight: bold;">
            年齢と性別は必須です。
          </div>
        </div>
      </div>
    `,
    choices: ['次へ進む'],
    on_load: () => {
      const button = document.querySelector('.jspsych-btn');
      button.addEventListener('click', (e) => {
        const age = document.getElementById('age_input')?.value;
        const gender = document.getElementById('gender_input')?.value;
        
        if (!age || !gender || age === '' || gender === '') {
          e.preventDefault();
          e.stopPropagation();
          document.getElementById('error_message').style.display = 'block';
          return false;
        }
      });
    },
    on_finish: (data) => {
      const age = document.getElementById('age_input')?.value || '';
      const gender = document.getElementById('gender_input')?.value || '';
      data.age = age;
      data.gender = gender;
      jsPsych.data.addProperties({
        age: age,
        gender: gender
      });
    }
  });

  // ゲームタイムライン構築
  const blockDecks = generateBlockDecks();
  let allDeckChoices = { A: 0, B: 0, C: 0, D: 0 };
  let allGains = [];
  let allLosses = [];

  for (let blockNum = 0; blockNum < NUM_BLOCKS; blockNum++) {
    const currentBlockDecks = blockDecks[blockNum];
    let blockGains = [];
    let blockLosses = [];
    let blockDeckChoices = { A: 0, B: 0, C: 0, D: 0 };

    // ブロック開始メッセージ
    timeline.push({
      type: window.jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="card">
          <h1>ブロック ${blockNum + 1}/${NUM_BLOCKS}</h1>
          <p style="text-align: center; color: #666;">このブロックでは16回の選択を行います。</p>
        </div>
      `,
      choices: ['開始']
    });

    // 16試行のループ
    for (let trialNum = 0; trialNum < TRIALS_PER_BLOCK; trialNum++) {
      // デッキ選択
      timeline.push({
        type: window.jsPsychHtmlButtonResponse,
        stimulus: function() {
          const currentMoney = INITIAL_MONEY + allGains.reduce((a, b) => a + b, 0) - allLosses.reduce((a, b) => a + b, 0);
          return `
            <div class="card">
              <h2>ブロック ${blockNum + 1}/4 - 試行 ${trialNum + 1}/16</h2>
              <p style="text-align: center; margin: 1rem 0;">4つの札の山から1つ選んでください</p>
              <div class="status-bar">
                <div class="status-item">
                  <div class="status-label">現在の資金</div>
                  <div class="status-value">${currentMoney}</div>
                </div>
                <div class="status-item">
                  <div class="status-label">進捗</div>
                  <div class="status-value">${trialNum + 1}/${TRIALS_PER_BLOCK}</div>
                </div>
              </div>
            </div>
          `;
        },
        choices: ['A ♠️', 'B ♥️', 'C ♦️', 'D ♣️'],
        on_load: () => {
          // ボタンをカスタマイズ
          const buttons = document.querySelectorAll('.jspsych-btn');
          const icons = ['♠️', '♥️', '♦️', '♣️'];
          const labels = ['A', 'B', 'C', 'D'];
          
          buttons.forEach((btn, idx) => {
            btn.innerHTML = `
              <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.8rem; font-weight: 700;">${labels[idx]}</span>
                <span style="font-size: 3rem; line-height: 1;">${icons[idx]}</span>
              </div>
            `;
            btn.style.cssText = `
              width: 140px;
              height: 180px;
              padding: 1.5rem;
              background: linear-gradient(135deg, #f0f7ff 0%, #e3f2fd 100%);
              border: 3px solid #0071e3;
              border-radius: 12px;
              cursor: pointer;
              font-size: 1rem;
              font-weight: 700;
              color: #0071e3;
              transition: all 0.2s ease;
              box-shadow: 0 4px 12px rgba(0, 113, 227, 0.15);
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 1rem;
            `;
            
            btn.addEventListener('mouseover', function() {
              this.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #d1e7ff 100%)';
              this.style.transform = 'translateY(-4px)';
              this.style.boxShadow = '0 8px 20px rgba(0, 113, 227, 0.25)';
            });
            
            btn.addEventListener('mouseout', function() {
              this.style.background = 'linear-gradient(135deg, #f0f7ff 0%, #e3f2fd 100%)';
              this.style.transform = 'translateY(0)';
              this.style.boxShadow = '0 4px 12px rgba(0, 113, 227, 0.15)';
            });
          });
        },
        on_finish: (data) => {
          const choices = ['A', 'B', 'C', 'D'];
          const choice = choices[data.response];
          const deck = currentBlockDecks[choice];
          const gain = deck.gains[Math.floor(Math.random() * deck.gains.length)];
          const loss = deck.losses[Math.floor(Math.random() * deck.losses.length)];
          const net = gain - loss;

          blockGains.push(gain);
          blockLosses.push(loss);
          blockDeckChoices[choice]++;
          allGains.push(gain);
          allLosses.push(loss);
          allDeckChoices[choice]++;

          data.gain = gain;
          data.loss = loss;
          data.net = net;
          data.choice = choice;
        }
      });

      // フィードバック
      timeline.push({
        type: window.jsPsychHtmlButtonResponse,
        stimulus: function() {
          const lastData = jsPsych.data.get().last(1).values()[0];
          const gain = lastData.gain;
          const loss = lastData.loss;
          const net = lastData.net;
          const currentMoney = INITIAL_MONEY + allGains.reduce((a, b) => a + b, 0) - allLosses.reduce((a, b) => a + b, 0);

          let icon = '💫';
          let message = '相殺';
          if (net > 0) {
            icon = '✨';
            message = '利益！';
          } else if (net < 0) {
            icon = '💥';
            message = '損失';
          }

          return `
            <div class="card" style="text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">${icon}</div>
              <h2>${message}</h2>
              <p style="margin: 1rem 0;">獲得: <strong>+${gain}</strong></p>
              <p style="margin: 1rem 0;">損失: <strong>−${loss}</strong></p>
              <p style="font-size: 1.2rem; font-weight: 700; margin-top: 1.5rem;">
                ${net >= 0 ? '+' : '−'}${Math.abs(net)}
              </p>
              <p style="margin-top: 1rem; color: #666;">現在の資金: ${currentMoney}</p>
            </div>
          `;
        },
        choices: ['次へ']
      });
    }

    // ブロック終了
    timeline.push({
      type: window.jsPsychHtmlButtonResponse,
      stimulus: function() {
        const blockTotal = blockGains.reduce((a, b) => a + b, 0) - blockLosses.reduce((a, b) => a + b, 0);
        const advantageous = (blockDeckChoices.C + blockDeckChoices.D) / TRIALS_PER_BLOCK * 100;
        const currentMoney = INITIAL_MONEY + allGains.reduce((a, b) => a + b, 0) - allLosses.reduce((a, b) => a + b, 0);

        return `
          <div class="card">
            <h1>ブロック ${blockNum + 1} 完了</h1>
            <div class="result-grid">
              <div class="result-item">
                <div class="result-label">ブロック収支</div>
                <div class="result-value ${blockTotal >= 0 ? 'positive' : 'negative'}">
                  ${blockTotal >= 0 ? '+' : '−'}${Math.abs(blockTotal)}
                </div>
              </div>
              <div class="result-item">
                <div class="result-label">有利な選択率</div>
                <div class="result-value">${advantageous.toFixed(1)}%</div>
              </div>
              <div class="result-item">
                <div class="result-label">累計資金</div>
                <div class="result-value">${currentMoney}</div>
              </div>
            </div>
          </div>
        `;
      },
      choices: [blockNum === NUM_BLOCKS - 1 ? '最終結果へ' : '次のブロックへ']
    });
  }

  // =====================================
  // データ保存試行（Datapipe経由）- 最終結果表示の前に実行
  // =====================================
  timeline.push({
    type: window.jsPsychPipe,
    action: 'save',
    experiment_id: 'RVTyUciz2P4q',
    filename: () => {
      try {
        const allData = jsPsych.data.get().values();
        const subjectId = allData.length > 0 ? allData[0].subject_id : 'unknown_subject';
        console.log('=== Pipe trial: filename:', subjectId);
        return `${subjectId}.csv`;
      } catch (e) {
        console.error('Filename error:', e);
        return 'unknown_subject.csv';
      }
    },
    data_string: () => {
      try {
        const csvData = jsPsych.data.get().csv();
        console.log('=== Pipe trial: CSV size:', csvData.length, 'bytes');
        return csvData;
      } catch (e) {
        console.error('CSV error:', e);
        return '';
      }
    },
    on_finish: () => {
      console.log('=== Pipe trial on_finish: Data saved successfully ===');
    }
  });

  // 最終結果表示
  timeline.push({
    type: window.jsPsychHtmlButtonResponse,
    stimulus: function() {
      const totalGains = allGains.reduce((a, b) => a + b, 0);
      const totalLosses = allLosses.reduce((a, b) => a + b, 0);
      const finalMoney = INITIAL_MONEY + totalGains - totalLosses;
      const advantageousChoices = (allDeckChoices.C + allDeckChoices.D) / TOTAL_TRIALS * 100;

      return `
        <div class="card">
          <h1>課題完了</h1>
          <p style="text-align: center; color: #666; margin: 1rem 0;">すべての試行が完了しました。</p>
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">最終資金</div>
              <div class="result-value ${finalMoney >= INITIAL_MONEY ? 'positive' : 'negative'}">
                ${finalMoney}
              </div>
            </div>
            <div class="result-item">
              <div class="result-label">総収支</div>
              <div class="result-value ${finalMoney >= INITIAL_MONEY ? 'positive' : 'negative'}">
                ${finalMoney >= INITIAL_MONEY ? '+' : '−'}${Math.abs(finalMoney - INITIAL_MONEY)}
              </div>
            </div>
            <div class="result-item">
              <div class="result-label">総利益</div>
              <div class="result-value positive">+${totalGains}</div>
            </div>
            <div class="result-item">
              <div class="result-label">総損失</div>
              <div class="result-value negative">−${totalLosses}</div>
            </div>
            <div class="result-item">
              <div class="result-label">有利な選択率</div>
              <div class="result-value">${advantageousChoices.toFixed(1)}%</div>
            </div>
            <div class="result-item">
              <div class="result-label">A選択</div>
              <div class="result-value">${allDeckChoices.A}</div>
            </div>
            <div class="result-item">
              <div class="result-label">B選択</div>
              <div class="result-value">${allDeckChoices.B}</div>
            </div>
            <div class="result-item">
              <div class="result-label">C選択</div>
              <div class="result-value">${allDeckChoices.C}</div>
            </div>
            <div class="result-item">
              <div class="result-label">D選択</div>
              <div class="result-value">${allDeckChoices.D}</div>
            </div>
          </div>
        </div>
      `;
    },
    choices: ['終了'],
    on_finish: (data) => {
      console.log('=== Final results screen completed ===');
      // Redirect after user confirms results
      setTimeout(() => {
        console.log('=== Redirecting ===');
        window.location.href = 'https://mshrymgc.github.io/epp_scales/';
      }, 500);
    }
  });

  // =====================================
  // 実行
  // =====================================
  jsPsych.run(timeline);
})();
  </script>
</body>
</html>
