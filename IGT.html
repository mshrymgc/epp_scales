<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>ã‚¢ã‚¤ã‚ªãƒ¯ã‚®ãƒ£ãƒ³ãƒ–ãƒªãƒ³ã‚°èª²é¡Œ</title>
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #f5f5f7 0%, #ffffff 100%);
    }

    .jspsych-content {
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    h1 {
      color: #1d1d1f;
      font-size: 1.8rem;
      margin: 0 0 1rem 0;
      font-weight: 700;
      text-align: center;
    }

    h2 {
      color: #0071e3;
      font-size: 1.3rem;
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
      font-weight: 600;
    }

    .instruction {
      color: #555;
      line-height: 1.8;
      font-size: 0.95rem;
      margin: 1rem 0 1.5rem 0;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      font-size: 1rem;
      margin-bottom: 2rem;
    }

    .content {
      color: #555;
      line-height: 1.8;
      font-size: 0.95rem;
    }

    .content p {
      margin-bottom: 1rem;
    }

    .content ul {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .content li {
      margin-bottom: 0.5rem;
    }

    .section {
      margin-bottom: 2rem;
    }

    .status-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f9f9fb;
      border-radius: 8px;
    }

    .status-item {
      text-align: center;
    }

    .status-label {
      font-size: 0.8rem;
      color: #999;
      margin-bottom: 0.3rem;
    }

    .status-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1d1d1f;
    }

    .deck-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin: 2rem 0;
    }

    .deck-btn {
      padding: 1.5rem 1rem;
      background: #f0f7ff;
      border: 2px solid #0071e3;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
      color: #0071e3;
      font-family: inherit;
    }

    .deck-btn:hover {
      background: #0071e3;
      color: white;
      transform: translateY(-2px);
    }

    .deck-btn:active {
      transform: translateY(0);
    }

    .deck-icon {
      font-size: 2.5rem;
      margin: 0.8rem 0;
      display: block;
    }

    .deck-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .deck-card {
      padding: 1.2rem;
      background: #f9f9fb;
      border-radius: 8px;
      border-left: 4px solid #999;
    }

    .deck-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .deck-label {
      font-size: 0.85rem;
      color: #999;
      margin-bottom: 0.3rem;
    }

    .deck-value {
      font-size: 0.95rem;
      margin: 0.3rem 0;
    }

    .advantageous {
      border-left-color: #34c759;
    }

    .disadvantageous {
      border-left-color: #ff3b30;
    }

    .feedback {
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: center;
      font-weight: 600;
      line-height: 1.6;
    }

    .feedback-positive {
      background: #d1f4d1;
      border-left: 4px solid #34c759;
      color: #1b5e20;
    }

    .feedback-negative {
      background: #fce4ec;
      border-left: 4px solid #ff3b30;
      color: #880e4f;
    }

    .feedback-neutral {
      background: #e3f2fd;
      border-left: 4px solid #0071e3;
      color: #1565c0;
    }

    .feedback-title {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }

    .feedback-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .feedback-details {
      font-size: 0.95rem;
      margin-top: 0.8rem;
    }

    .important-box {
      background: #e3f2fd;
      border-left: 4px solid #0071e3;
      padding: 1.2rem;
      border-radius: 8px;
      margin: 1.5rem 0;
    }

    .important-box p {
      color: #1565c0;
      margin: 0;
    }

    .example-box {
      background: #f0f7ff;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-size: 0.9rem;
      color: #333;
    }

    .example-box strong {
      color: #0071e3;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .result-item {
      padding: 1rem;
      background: #f9f9fb;
      border-radius: 8px;
      text-align: center;
    }

    .result-label {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }

    .result-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1d1d1f;
    }

    .result-value.positive {
      color: #34c759;
    }

    .result-value.negative {
      color: #ff3b30;
    }

    .jspsych-btn {
      background: #0071e3;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 0.5rem;
      font-family: inherit;
    }

    .jspsych-btn:hover {
      background: #0077cc;
    }

    .jspsych-btn:active {
      background: #0071e3;
    }

    .highlight {
      color: #0071e3;
      font-weight: 600;
    }

    .icon {
      font-size: 1.5rem;
      margin-right: 0.5rem;
    }

    @media (max-width: 600px) {
      .card {
        padding: 1.5rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      h2 {
        font-size: 1.1rem;
      }

      .deck-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
      }

      .deck-btn {
        padding: 1rem 0.7rem;
      }

      .deck-icon {
        font-size: 2rem;
        margin: 0.5rem 0;
      }

      .status-bar {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .result-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .deck-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <script>
    // =====================================
    // ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†
    // =====================================
    let appState = 'welcome'; // 'welcome', 'game'
    let jsPsych = null;
    const TRIALS_PER_BLOCK = 16;
    const NUM_BLOCKS = 4;
    const TOTAL_TRIALS = TRIALS_PER_BLOCK * NUM_BLOCKS;
    const INITIAL_MONEY = 2000;

    // =====================================
    // ãƒ‡ãƒƒã‚­å®šç¾©ï¼ˆå ±é…¬ã¨æå¤±ã‚’å¤‰å‹•ã•ã›ã‚‹ï¼‰
    // =====================================
    const baseDeckDefinitions = {
      // å±± A: é«˜ãƒªã‚¹ã‚¯ãƒ»é«˜ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆå¹³å‡ç²å¾—ï¼š100ã€å¹³å‡æå¤±ï¼šâˆ’250ï¼‰
      A: { 
        gains: [75, 100, 125],
        losses: [200, 250, 250, 300]
      },
      // å±± B: è¶…é«˜ãƒªã‚¹ã‚¯ãƒ»é«˜ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆå¹³å‡ç²å¾—ï¼š100ã€å¹³å‡æå¤±ï¼šâˆ’1250ï¼‰
      B: { 
        gains: [75, 100, 125],
        losses: [1000, 1250, 1250, 1500]
      },
      // å±± C: ä½ãƒªã‚¹ã‚¯ãƒ»ä½ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆå¹³å‡ç²å¾—ï¼š50ã€å¹³å‡æå¤±ï¼šâˆ’25ï¼ˆ50%ã®ç¢ºç‡ã§0ï¼‰ï¼‰
      C: { 
        gains: [25, 50, 75],
        losses: [25, 50, 50, 75, 0, 0, 0, 0, 0, 0, 0, 0]
      },
      // å±± D: ä½ãƒªã‚¹ã‚¯ãƒ»ä½ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆå¹³å‡ç²å¾—ï¼š50ã€å¹³å‡æå¤±ï¼šâˆ’100ï¼ˆ50%ã®ç¢ºç‡ã§0ï¼‰ï¼‰
      D: { 
        gains: [25, 50, 75],
        losses: [150, 200, 200, 250, 0, 0, 0, 0, 0, 0, 0, 0]
      }
    };

    function generateBlockDecks() {
      const blockDecks = [];
      for (let i = 0; i < NUM_BLOCKS; i++) {
        const disadvantageous = Math.random() > 0.5 ? ['A', 'B'] : ['B', 'A'];
        const advantageous = Math.random() > 0.5 ? ['C', 'D'] : ['D', 'C'];
        const decks = {};
        disadvantageous.forEach(key => {
          decks[key] = JSON.parse(JSON.stringify(baseDeckDefinitions[key]));
        });
        advantageous.forEach(key => {
          decks[key] = JSON.parse(JSON.stringify(baseDeckDefinitions[key]));
        });
        blockDecks.push(decks);
      }
      return blockDecks;
    }

    // =====================================
    // Welcomeãƒšãƒ¼ã‚¸HTMLã®ç”Ÿæˆ
    // =====================================
    function generateWelcomeContent() {
      return `
        <div class="card" style="max-width: 800px; margin: 2rem auto;">
          <h1><span class="icon">ğŸ°</span>ã‚¢ã‚¤ã‚ªãƒ¯ã‚®ãƒ£ãƒ³ãƒ–ãƒªãƒ³ã‚°èª²é¡Œ</h1>
          <p class="subtitle">ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«èª¬æ˜</p>

          <div class="section">
            <h2>ğŸ“ èª²é¡Œã®ç›®çš„</h2>
            <div class="content">
              <p>ã“ã®èª²é¡Œã¯ã€<span class="highlight">æ„æ€æ±ºå®šèƒ½åŠ›ã¨å­¦ç¿’èƒ½åŠ›ã‚’æ¸¬å®š</span>ã—ã¾ã™ã€‚ã‚ãªãŸã¯4ã¤ã®æœ­ã®å±±ã‹ã‚‰ç¹°ã‚Šè¿”ã—é¸æŠã‚’è¡Œã„ã€åˆ©ç›Šã‚’æœ€å¤§åŒ–ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚</p>
            </div>
          </div>

          <div class="section">
            <h2>ğŸ® ã‚²ãƒ¼ãƒ ã®æµã‚Œ</h2>
            <div class="content">
              <p>èª²é¡Œã¯<span class="highlight">4ã¤ã®ãƒ–ãƒ­ãƒƒã‚¯</span>ã§æ§‹æˆã•ã‚Œã€å„ãƒ–ãƒ­ãƒƒã‚¯ã§<span class="highlight">16å›ã®è©¦è¡Œ</span>ã‚’è¡Œã„ã¾ã™ã€‚ï¼ˆåˆè¨ˆ64è©¦è¡Œï¼‰</p>
              <ul>
                <li><strong>åˆæœŸè³‡é‡‘:</strong> 2,000</li>
                <li><strong>å„ãƒ–ãƒ­ãƒƒã‚¯:</strong> 16å›ã®é¸æŠ</li>
                <li><strong>ãƒ–ãƒ­ãƒƒã‚¯é–“:</strong> è³‡é‡‘ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</li>
                <li><strong>æœ€çµ‚çµæœ:</strong> ã™ã¹ã¦ã®ãƒ–ãƒ­ãƒƒã‚¯ã®æˆç¸¾ã‚’é›†è¨ˆã—ã¾ã™</li>
              </ul>
            </div>
          </div>

          <div class="section">
            <h2>ğŸ“Š è©¦è¡Œã®æµã‚Œ</h2>
            <div class="content">
              <p><strong>å„è©¦è¡Œã§ã¯ä»¥ä¸‹ã®æ‰‹é †ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ï¼š</strong></p>
              <ol style="margin-left: 1.5rem;">
                <li>4ã¤ã®æœ­ã®å±±ï¼ˆA, B, C, Dï¼‰ã‹ã‚‰1ã¤ã‚’é¸æŠã—ã¾ã™</li>
                <li>ãã®å±±ã‹ã‚‰æœ­ã‚’1æšå¼•ãã¾ã™</li>
                <li>ç²å¾—é¡ã¨æå¤±é¡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                <li>ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¬¡ã®è©¦è¡Œã«é€²ã¿ã¾ã™</li>
              </ol>
            </div>

            <div class="example-box">
              <strong>ä¾‹ï¼‰å±± C ã‚’é¸ã‚“ã å ´åˆï¼š</strong><br>
              ç²å¾—: +50 / æå¤±: âˆ’0 â†’ <span style="color: #34c759; font-weight: 700;">+50 ã®åˆ©ç›Š</span><br>
              <br>
              <strong>ä¾‹ï¼‰å±± A ã‚’é¸ã‚“ã å ´åˆï¼š</strong><br>
              ç²å¾—: +100 / æå¤±: âˆ’250 â†’ <span style="color: #ff3b30; font-weight: 700;">âˆ’150 ã®æå¤±</span>
            </div>
          </div>

          <div class="section">
            <h2>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ</h2>
            <div class="content">
              <ul>
                <li><strong>å­¦ç¿’ãŒé‡è¦:</strong> æœ€åˆã¯å„å±±ã®ç‰¹æ€§ãŒåˆ†ã‹ã‚Šã¾ã›ã‚“ãŒã€è©¦è¡Œã‚’é‡ã­ã‚‹ã«ã¤ã‚Œã¦å­¦ç¿’ã—ã¾ã™</li>
                <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º:</strong> ç¾åœ¨ã®è³‡é‡‘ã¨è©¦è¡Œæ•°ã¯ã„ã¤ã§ã‚‚ç¢ºèªã§ãã¾ã™</li>
                <li><strong>ãƒšãƒ¼ã‚¹ç®¡ç†:</strong> è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§é€²ã‚ã¦ãã ã•ã„ã€‚æ™‚é–“åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                <li><strong>æˆ¦ç•¥æ€§:</strong> çŸ­æœŸçš„ãªåˆ©ç›Šã¨é•·æœŸçš„ãªæœ€é©æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™</li>
              </ul>
            </div>
          </div>

          <div class="section">
            <h2>ğŸ“ˆ çµæœè¡¨ç¤º</h2>
            <div class="content">
              <p>å„ãƒ–ãƒ­ãƒƒã‚¯çµ‚äº†æ™‚ã¨èª²é¡Œå…¨ä½“çµ‚äº†æ™‚ã«ä»¥ä¸‹ã®çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š</p>
              <ul>
                <li>æœ€çµ‚è³‡é‡‘</li>
                <li>ç·åæ”¯ï¼ˆåˆ©ç›Šãƒ»æå¤±ï¼‰</li>
                <li>å„å±±ã®é¸æŠå›æ•°</li>
                <li>æœ‰åˆ©ãªå±±ï¼ˆCãƒ»Dï¼‰ã®é¸æŠç‡</li>
              </ul>
            </div>
          </div>

          <div class="important-box">
            <p><strong>âœ¨ æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ</strong><br>
            ä»¥ä¸‹ã®ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€èª²é¡ŒãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
            <button class="jspsych-btn" onclick="location.href='index.html'" style="background: #f0f0f0; color: #333;">â† æˆ»ã‚‹</button>
            <button class="jspsych-btn" onclick="startGame();">ğŸ® èª²é¡Œã‚’é–‹å§‹</button>
          </div>
        </div>
      `;
    }

    // =====================================
    // ã‚²ãƒ¼ãƒ é–‹å§‹é–¢æ•°
    // =====================================
    function startGame() {
      appState = 'game';
      document.body.innerHTML = '';
      
      jsPsych = initJsPsych();
      const blockDecks = generateBlockDecks();

      // è©¦è¡Œãƒ‡ãƒ¼ã‚¿
      let allDeckChoices = { A: 0, B: 0, C: 0, D: 0 };
      let allGains = [];
      let allLosses = [];
      let blockResults = [];

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
      const timeline = [];

      // ãƒ–ãƒ­ãƒƒã‚¯ãƒ«ãƒ¼ãƒ—æ§‹ç¯‰é–¢æ•°
      function buildBlockTimeline(blockNum) {
        const currentBlockDecks = blockDecks[blockNum];
        let blockGains = [];
        let blockLosses = [];
        let blockDeckChoices = { A: 0, B: 0, C: 0, D: 0 };

        // ãƒ–ãƒ­ãƒƒã‚¯é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="card">
              <h1>ãƒ–ãƒ­ãƒƒã‚¯ ${blockNum + 1}/${NUM_BLOCKS}</h1>
              <p style="color: #666; text-align: center; margin: 1.5rem 0; font-size: 1.1rem;">
                ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã¯16å›ã®è©¦è¡Œã‚’è¡Œã„ã¾ã™ã€‚<br>
                4ã¤ã®æœ­ã®å±±ï¼ˆA, B, C, Dï¼‰ã‹ã‚‰1ã¤ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
              </p>
              <div class="status-bar">
                <div class="status-item">
                  <div class="status-label">ç¾åœ¨ã®è³‡é‡‘</div>
                  <div class="status-value">${INITIAL_MONEY + allGains.reduce((a, b) => a + b, 0) - allLosses.reduce((a, b) => a + b, 0)}</div>
                </div>
                <div class="status-item">
                  <div class="status-label">é€²æ—</div>
                  <div class="status-value">${blockNum + 1}/${NUM_BLOCKS}</div>
                </div>
              </div>
            </div>
          `,
          choices: ['é–‹å§‹'],
          button_html: '<button class="jspsych-btn">%choice%</button>'
        });

        // ãƒ–ãƒ­ãƒƒã‚¯å†…ã®16è©¦è¡Œ
        for (let trialInBlock = 1; trialInBlock <= TRIALS_PER_BLOCK; trialInBlock++) {
          const trialBlockNum = blockNum;
          const trialNum = trialInBlock;
          
          timeline.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
              const currentMoney = INITIAL_MONEY + allGains.reduce((a, b) => a + b, 0) - allLosses.reduce((a, b) => a + b, 0);
              return `
                <div class="card">
                  <h1>ãƒ–ãƒ­ãƒƒã‚¯ ${trialBlockNum + 1}/${NUM_BLOCKS}</h1>
                  <div class="instruction">
                    <p>4ã¤ã®æœ­ã®å±±ï¼ˆA, B, C, Dï¼‰ã‹ã‚‰1ã¤ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
                  </div>
                  <div class="status-bar">
                    <div class="status-item">
                      <div class="status-label">ç¾åœ¨ã®è³‡é‡‘</div>
                      <div class="status-value">${currentMoney}</div>
                    </div>
                    <div class="status-item">
                      <div class="status-label">è©¦è¡Œæ•°</div>
                      <div class="status-value">${trialNum}/${TRIALS_PER_BLOCK}</div>
                    </div>
                  </div>
                  <div class="deck-container">
                    <button class="deck-btn">A<span class="deck-icon">ğŸ‚¡</span></button>
                    <button class="deck-btn">B<span class="deck-icon">ğŸ‚²</span></button>
                    <button class="deck-btn">C<span class="deck-icon">ğŸ‚³</span></button>
                    <button class="deck-btn">D<span class="deck-icon">ğŸ‚´</span></button>
                  </div>
                </div>
              `;
            },
            choices: ['A', 'B', 'C', 'D'],
            button_html: '<button style="display: none;"></button>',
            on_load: function() {
              const buttons = document.querySelectorAll('.deck-btn');
              const choices = ['A', 'B', 'C', 'D'];
              buttons.forEach((btn, idx) => {
                btn.onclick = () => {
                  jsPsych.finishTrial({ choice: choices[idx] });
                };
              });
            },
            on_finish: function(data) {
              const choice = data.choice;
              const deck = currentBlockDecks[choice];
              const gain = deck.gains[Math.floor(Math.random() * deck.gains.length)];
              const loss = deck.losses[Math.floor(Math.random() * deck.losses.length)];
              const net = gain - loss;

              blockGains.push(gain);
              blockLosses.push(loss);
              blockDeckChoices[choice]++;
              allGains.push(gain);
              allLosses.push(loss);
              allDeckChoices[choice]++;

              data.gain = gain;
              data.loss = loss;
              data.net = net;
            }
          });

          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è©¦è¡Œ
          timeline.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
              const lastData = jsPsych.data.get().last(1).values()[0];
              const gain = lastData.gain;
              const loss = lastData.loss;
              const net = lastData.net;
              const currentMoney = INITIAL_MONEY + allGains.reduce((a, b) => a + b, 0) - allLosses.reduce((a, b) => a + b, 0);

              let feedbackClass = 'feedback-neutral';
              let icon = 'ğŸ’«';
              let message = 'ç›¸æ®ºã•ã‚Œã¾ã—ãŸ';

              if (net > 0) {
                feedbackClass = 'feedback-positive';
                icon = 'âœ¨';
                message = 'åˆ©ç›Šã‚’ç²å¾—ï¼';
              } else if (net < 0) {
                feedbackClass = 'feedback-negative';
                icon = 'ğŸ’¥';
                message = 'æå¤±ãŒç™ºç”Ÿ...';
              }

              return `
                <div class="card">
                  <div class="feedback ${feedbackClass}">
                    <span class="feedback-icon">${icon}</span>
                    <div class="feedback-title">${message}</div>
                    <div class="feedback-details">
                      <div>ç²å¾—: <strong style="font-size: 1.1rem;">+${gain}</strong></div>
                      <div style="margin-top: 0.3rem;">æå¤±: <strong style="font-size: 1.1rem;">âˆ’${loss}</strong></div>
                      <div style="margin-top: 0.5rem; font-size: 1.2rem; font-weight: 700;">
                        ${net >= 0 ? '+' : 'âˆ’'}${Math.abs(net)}
                      </div>
                    </div>
                  </div>
                  <div class="status-bar" style="margin-top: 1.5rem;">
                    <div class="status-item">
                      <div class="status-label">ç¾åœ¨ã®è³‡é‡‘</div>
                      <div class="status-value">${currentMoney}</div>
                    </div>
                    <div class="status-item">
                      <div class="status-label">é¸æŠã—ãŸãƒ‡ãƒƒã‚­</div>
                      <div class="status-value">${lastData.choice}</div>
                    </div>
                  </div>
                </div>
              `;
            },
            choices: ['æ¬¡ã¸'],
            button_html: '<button class="jspsych-btn">%choice%</button>'
          });
        }

        // ãƒ–ãƒ­ãƒƒã‚¯çµ‚äº†ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: function() {
            const blockGainsTotal = blockGains.reduce((a, b) => a + b, 0);
            const blockLossesTotal = blockLosses.reduce((a, b) => a + b, 0);
            const blockNetResult = blockGainsTotal - blockLossesTotal;
            const blockFinalMoney = INITIAL_MONEY + allGains.reduce((a, b) => a + b, 0) - allLosses.reduce((a, b) => a + b, 0);
            const advantageousChoices = (blockDeckChoices.C + blockDeckChoices.D) / TRIALS_PER_BLOCK * 100;

            return `
              <div class="card">
                <h1>ãƒ–ãƒ­ãƒƒã‚¯ ${blockNum + 1} å®Œäº†</h1>
                <p style="color: #666; text-align: center; margin: 1rem 0;">ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®çµæœã§ã™ã€‚</p>
                <div class="result-grid">
                  <div class="result-item">
                    <div class="result-label">ãƒ–ãƒ­ãƒƒã‚¯åæ”¯</div>
                    <div class="result-value ${blockNetResult >= 0 ? 'positive' : 'negative'}">
                      ${blockNetResult >= 0 ? '+' : 'âˆ’'}${Math.abs(blockNetResult)}
                    </div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">ç´¯è¨ˆè³‡é‡‘</div>
                    <div class="result-value">${blockFinalMoney}</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">æœ‰åˆ©ãªé¸æŠç‡</div>
                    <div class="result-value">${advantageousChoices.toFixed(1)}%</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">Aé¸æŠ</div>
                    <div class="result-value">${blockDeckChoices.A}</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">Bé¸æŠ</div>
                    <div class="result-value">${blockDeckChoices.B}</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">Cé¸æŠ</div>
                    <div class="result-value">${blockDeckChoices.C}</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">Dé¸æŠ</div>
                    <div class="result-value">${blockDeckChoices.D}</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">ãƒ–ãƒ­ãƒƒã‚¯é€²æ—</div>
                    <div class="result-value">${blockNum + 1}/${NUM_BLOCKS}</div>
                  </div>
                </div>
              </div>
            `;
          },
          choices: [blockNum === NUM_BLOCKS - 1 ? 'æœ€çµ‚çµæœã¸' : 'æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¸'],
          button_html: '<button class="jspsych-btn">%choice%</button>'
        });

        // ãƒ–ãƒ­ãƒƒã‚¯çµæœã‚’ä¿å­˜
        blockResults.push({
          block: blockNum + 1,
          gains: blockGains,
          losses: blockLosses,
          deckChoices: { ...blockDeckChoices }
        });
      }

      // å„ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰
      for (let blockNum = 0; blockNum < NUM_BLOCKS; blockNum++) {
        buildBlockTimeline(blockNum);
      }

      // æœ€çµ‚çµæœè¡¨ç¤ºè©¦è¡Œ
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: function() {
          const totalGains = allGains.reduce((a, b) => a + b, 0);
          const totalLosses = allLosses.reduce((a, b) => a + b, 0);
          const finalMoney = INITIAL_MONEY + totalGains - totalLosses;
          const advantageousChoices = (allDeckChoices.C + allDeckChoices.D) / TOTAL_TRIALS * 100;

          return `
            <div class="card">
              <h1>èª²é¡Œå®Œäº†</h1>
              <p style="color: #666; text-align: center; margin: 1rem 0;">ã™ã¹ã¦ã®è©¦è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
              <div class="result-grid">
                <div class="result-item">
                  <div class="result-label">æœ€çµ‚è³‡é‡‘</div>
                  <div class="result-value ${finalMoney >= INITIAL_MONEY ? 'positive' : 'negative'}">
                    ${finalMoney}
                  </div>
                </div>
                <div class="result-item">
                  <div class="result-label">ç·åæ”¯</div>
                  <div class="result-value ${finalMoney >= INITIAL_MONEY ? 'positive' : 'negative'}">
                    ${finalMoney >= INITIAL_MONEY ? '+' : 'âˆ’'}${Math.abs(finalMoney - INITIAL_MONEY)}
                  </div>
                </div>
                <div class="result-item">
                  <div class="result-label">ç·åˆ©ç›Š</div>
                  <div class="result-value positive">+${totalGains}</div>
                </div>
                <div class="result-item">
                  <div class="result-label">ç·æå¤±</div>
                  <div class="result-value negative">âˆ’${totalLosses}</div>
                </div>
                <div class="result-item">
                  <div class="result-label">æœ‰åˆ©ãªé¸æŠç‡</div>
                  <div class="result-value">${advantageousChoices.toFixed(1)}%</div>
                </div>
                <div class="result-item">
                  <div class="result-label">Aé¸æŠ</div>
                  <div class="result-value">${allDeckChoices.A}</div>
                </div>
                <div class="result-item">
                  <div class="result-label">Bé¸æŠ</div>
                  <div class="result-value">${allDeckChoices.B}</div>
                </div>
                <div class="result-item">
                  <div class="result-label">Cé¸æŠ</div>
                  <div class="result-value">${allDeckChoices.C}</div>
                </div>
                <div class="result-item">
                  <div class="result-label">Dé¸æŠ</div>
                  <div class="result-value">${allDeckChoices.D}</div>
                </div>
              </div>

              <div class="section" style="margin-top: 2rem;">
                <h2 style="margin-top: 0;">ğŸƒ 4ã¤ã®æœ­ã®å±±</h2>
                <div class="content">
                  <p>èª²é¡Œã§ä½¿ç”¨ã•ã‚ŒãŸ4ã¤ã®æœ­ã®å±±ã®ç‰¹æ€§ã§ã™ï¼š</p>
                </div>
                <div class="deck-grid">
                  <div class="deck-card disadvantageous">
                    <div class="deck-name">å±± A</div>
                    <div class="deck-label">é«˜ãƒªã‚¹ã‚¯ãƒ»é«˜ãƒªã‚¿ãƒ¼ãƒ³</div>
                    <div class="deck-value">ğŸ’° ç²å¾—: +100</div>
                    <div class="deck-value">ğŸ’” æå¤±: âˆ’250</div>
                  </div>
                  <div class="deck-card disadvantageous">
                    <div class="deck-name">å±± B</div>
                    <div class="deck-label">è¶…é«˜ãƒªã‚¹ã‚¯ãƒ»é«˜ãƒªã‚¿ãƒ¼ãƒ³</div>
                    <div class="deck-value">ğŸ’° ç²å¾—: +100</div>
                    <div class="deck-value">ğŸ’” æå¤±: âˆ’1,250</div>
                  </div>
                  <div class="deck-card advantageous">
                    <div class="deck-name">å±± C</div>
                    <div class="deck-label">ä½ãƒªã‚¹ã‚¯ãƒ»ä½ãƒªã‚¿ãƒ¼ãƒ³</div>
                    <div class="deck-value">ğŸ’° ç²å¾—: +50</div>
                    <div class="deck-value">ğŸ’” æå¤±: âˆ’50ï¼ˆ50%ï¼‰</div>
                  </div>
                  <div class="deck-card advantageous">
                    <div class="deck-name">å±± D</div>
                    <div class="deck-label">ä½ãƒªã‚¹ã‚¯ãƒ»ä½ãƒªã‚¿ãƒ¼ãƒ³</div>
                    <div class="deck-value">ğŸ’° ç²å¾—: +50</div>
                    <div class="deck-value">ğŸ’” æå¤±: âˆ’200ï¼ˆ50%ï¼‰</div>
                  </div>
                </div>

                <div class="important-box">
                  <p><strong>âš ï¸ é‡è¦:</strong> å±± C ã¨ D ã¯ <strong>50%ã®ç¢ºç‡ã§æå¤±ãŒã‚ã‚Šã¾ã›ã‚“</strong>ã€‚ã“ã‚Œã‚‰ã¯é•·æœŸçš„ã«æœ‰åˆ©ã§ã™ãŒã€å±± Aãƒ»B ã‚ˆã‚Šã‚‚ãƒªã‚¿ãƒ¼ãƒ³ãŒå°ã•ã„ã§ã™ã€‚</p>
                </div>
              </div>
            </div>
          `;
        },
        choices: ['çµ‚äº†'],
        button_html: '<button class="jspsych-btn">%choice%</button>'
      });

      // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="card">
            <h1>ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</h1>
            <p style="color: #666; text-align: center; line-height: 1.8; margin: 1.5rem 0;">
              ã‚¢ã‚¤ã‚ªãƒ¯ã‚®ãƒ£ãƒ³ãƒ–ãƒªãƒ³ã‚°èª²é¡Œã¯ã€æ„æ€æ±ºå®šã¨å­¦ç¿’ã«é–¢ã™ã‚‹ç ”ç©¶ã§åºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
              ã‚ãªãŸã®é¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ãƒªã‚¹ã‚¯é¸å¥½ã¨å­¦ç¿’èƒ½åŠ›ãŒè©•ä¾¡ã•ã‚Œã¾ã™ã€‚
            </p>
          </div>
        `,
        choices: ['å®Œäº†'],
        button_html: '<button class="jspsych-btn">%choice%</button>'
      });

      // å®Ÿè¡Œ
      jsPsych.run(timeline);
    }

    // =====================================
    // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
    // =====================================
    document.addEventListener('DOMContentLoaded', function() {
      document.body.innerHTML = generateWelcomeContent();
    });
  </script>
</head>
<body>
  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JavaScriptã§å‹•çš„ã«æŒ¿å…¥ -->
</body>
</html>
